---
title: "Hatchling counts at Raine Island"
author: "Tomo Eguchi"
date: "`r Sys.Date()`"
output: 
  bookdown::word_document2: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

# # remove all pakcages - detach() removes the first one.
# loaded.packages <- (.packages())
# if (length(loaded.packages > 0)){
#   for (k in 1:length(loaded.packages)){
#     detach()
#   }
# }

rm(list = ls())
library(tidyverse)
library(readr)
library(flextable)

set_flextable_defaults(font.size = 9,
                       font.family = "Cambria")

save.fig.fcn <- function(fig, file.name, replace = F, dpi = 600, device = "png",
           height = 3, width = 5, units = "in",
           bg = "white"){
  if (isTRUE(replace) | (!isTRUE(replace) & !file.exists(file.name)))
    ggsave(fig, 
           filename = file.name, 
           dpi = dpi, device = device,
           height = height, width = width, units = units,
           bg = bg)
  
}


save.fig <- T
dpi.set <- 600

```

At Raine Island, annual hatchling production has been determined via counts of hatchlings on the beach. Observers are stationed at multiple sectors, where they count hatchlings that come down the beach. A trench is dug and all hatchlings that fall into the trench are counted and released. During the 2018-2019 season, the survey was changed from 12 hrs (1800 to 0600) to 6 hrs (1800 - 0000) for logistical reasons. Furthermore, some counts were made from 100-m trenches whereas others were counted in 50-m trenches.

In order to look at possible effects of differences in sampling scheme (i.e., 12hr vs 6 hr and 100m vs 50m), I explore hatchling count data while standardizing the sampling duration and trench lengths.

```{r data-import, include=FALSE, echo=FALSE, message=FALSE, warning=FALSE}

col.def <- cols(date = col_date(format = "%d/%m/%Y"),
                sector = col_factor(levels = c("A", "A2", "B", "D", "2014S", "2017S", "2019S", "2019N")),
                island = col_character(),
                trench_length_m = col_double(), 
                survey_length = col_character(), 
                total_before_1800 = col_integer(), 
                total_1800_1900 = col_integer(), 
                total_1900_2000 = col_integer(), 
                total_2000_2100 = col_integer(),
                total_2100_2200 = col_integer(),
                total_2200_2300 = col_integer(),
                total_2300_2400 = col_integer(),
                total_2400_0100 = col_integer(),
                total_0100_0200 = col_integer(), 
                total_0200_0300 = col_integer(),
                total_0300_0400 = col_integer(),
                total_0400_0500 = col_integer(),
                total_0500_0600 = col_integer(),
                total_after_0600 = col_integer(),
                nightly_total = col_integer())

data.0 <- read_csv(file = "data/hatch_count_fullcount_2014-15-2021-22.csv",
                   col_types = col.def) %>% 
  discard(~ all(is.na(.))) %>%
  mutate(survey_duration_hr = ifelse(survey_length == "12hr", 12, 6)) %>%
  mutate(year = lubridate::year(date),
         month = lubridate::month(date)) 


data.0 %>%
  select(-c("survey_length", "nightly_total")) %>%
  pivot_longer(data.0,
               cols = starts_with("total"),
               names_to = "time",
               values_to = "counts") %>%
  mutate(hr = ifelse(time == "total_before_1800", 0,
                     ifelse(time == "total_1800_1900", 1,
                            ifelse(time == "total_1900_2000", 2,
                                   ifelse(time == "total_2000_2100", 3,
                                          ifelse(time == "total_2100_2200", 4,
                                                 ifelse(time == "total_2200_2300", 5,
                                                        ifelse(time == "total_2300_2400", 6,
                                                               ifelse(time == "total_2400_0100", 7,
                                                                      ifelse(time == "total_0100_0200", 8,
                                                                             ifelse(time == "total_0200_0300", 9,
                                                                                    ifelse(time == "total_0300_0400", 10,
                                                                                           ifelse(time == "total_0400_0500", 11,
                                                                                                  ifelse(time == "total_0500_0600", 12, 13)))))))))))))) %>%
  mutate(counts_m = counts/trench_length_m) %>%
  mutate(counts_m_NA = ifelse((survey_duration_hr == 6 & hr > 6), NA, counts_m)) -> data.1


```


```{r pivot-check, message=FALSE, echo=FALSE, warning=FALSE}
# Make sure the pivoting worked correctly:

data.0 %>% 
  filter(year == 2020, sector == "A") %>%
  mutate(date.f = as.factor(date)) %>%
  group_by(date.f) %>%
  rowwise() %>%
  mutate(daily.sum = sum(c_across(starts_with("total")))) -> data.0.A.2020.daily.sum


data.1 %>% 
  filter(year == 2020, sector == "A") %>%
  mutate(date.f = as.factor(date)) %>%
  group_by(date.f) %>%
  summarize(daily.sum = sum(counts, na.rm = T)) -> data.1.A.2020.daily.sum


data.0 %>% 
  filter(year == 2015, sector == "2014S") %>%
  mutate(date.f = as.factor(date)) %>%
  group_by(date.f) %>%
  rowwise() %>%
  mutate(daily.sum = sum(c_across(starts_with("total")), na.rm = T)) -> data.0.2014S.2015.daily.sum


data.1 %>% 
  filter(year == 2015, sector == "2014S") %>%
  mutate(date.f = as.factor(date)) %>%
  group_by(date.f) %>%
  summarize(daily.sum = sum(counts, na.rm = T)) -> data.1.2014S.2015.daily.sum

# Two sets are the same so I assume that the pivoting operations worked fine to convert the wide format to long format.

```



```{r raw-plot, echo=FALSE, message=FALSE, warning=FALSE}
p.raw.counts <- ggplot(data = data.1) +
  # geom_point(aes(x = hr, 
  #                y = counts, 
  #                color = sector)) +
  geom_path(aes(x = hr, 
                 y = counts_m_NA, 
                 color = as.factor(year))) +
  facet_wrap(~sector, nrow = 2) +
  labs(color = "Year") +
  xlab("Hours since 1800") + ylab("# hatchlings per meter")

save.fig.fcn(p.raw.counts, 
             file.name = paste0("figures/raw_counts_", dpi.set, "dpi.png"), 
             replace = T, dpi = dpi.set)

```

```{r Figure-raw-counts, echo=FALSE, message=FALSE, fig.cap="The number of hatchlings per meter at 8 sectors."}

knitr::include_graphics(paste0("figures/raw_counts_", dpi.set, "dpi.png"))

```

In general, greater numbers of hatchlings were counted before midnight (6hrs since 1800) than after (Figure \@ref(fig:Figure-raw-counts)). In order to look at the details, each sector was examined separately. 


## Sector A {-}

```{r sector-A, echo=FALSE, message=FALSE, warning=FALSE}

data.1 %>% filter(sector == "A") -> data.1.A

p.sector.A.1 <- ggplot(data.1.A) +
  geom_path(aes(x = hr, y = counts_m_NA)) +
  facet_wrap(~year) + 
  xlab("Hours since 1800") +
  ylab("# hatchlings per meter")

save.fig.fcn(p.sector.A.1, 
             file.name = paste0("figures/sector_A_", dpi.set, "dpi.png"), 
             replace = T, dpi = dpi.set)

```

At sector A, only 6-hr surveys were conducted in `r min(data.1.A$year)` - `r max(data.1.A$year)`. The observed variability among surveys in 2020 was large (Figure \@ref(fig:Figure-sector-A)).


```{r Figure-sector-A, echo=FALSE, message=FALSE, fig.cap="The number of hatchlings per meter at sector A."}

knitr::include_graphics(paste0("figures/sector_A_", dpi.set, "dpi.png"))

```


## Sector A2 {-}

```{r sector-A2, echo=FALSE, message=FALSE, warning=FALSE}

data.1 %>% filter(sector == "A2") -> data.1.A2

p.sector.A2.1 <- ggplot(data.1.A2) +
  geom_path(aes(x = hr, y = counts_m_NA)) +
  facet_wrap(~year)+ 
  xlab("Hours since 1800") +
  ylab("# hatchlings per meter")


save.fig.fcn(p.sector.A2.1, 
             file.name = paste0("figures/sector_A2_", dpi.set, "dpi.png"), 
             replace = T, dpi = dpi.set)

```

In sector A2, 12-hr surveys were conducted from 2015 to 2018, whereas 6-hr surveys were conducted in 2019. 12-hr surveys indicated that hourly counts of hatchlings reached greatest in the first 6 hrs, especially 3-4 hrs from the beginning of each survey (2100-2200) and declined subsequently (Figure \@ref(fig:Figure-sector-A2)).


```{r Figure-sector-A2, echo=FALSE, message=FALSE, fig.cap="The number of hatchlings per meter at sector A2."}

knitr::include_graphics(paste0("figures/sector_A2_", dpi.set, "dpi.png"))

```

## Sector B {-}

```{r sector-B, echo=FALSE, message=FALSE, warning=FALSE}

data.1 %>% filter(sector == "B") -> data.1.B

p.sector.B.1 <- ggplot(data.1.B) +
  geom_path(aes(x = hr, y = counts_m_NA)) +
  facet_wrap(~year)+ 
  xlab("Hours since 1800") +
  ylab("# hatchlings per meter")


save.fig.fcn(p.sector.B.1, 
             file.name = paste0("figures/sector_B_", dpi.set, "dpi.png"), 
             replace = T, dpi = dpi.set)

```


In sector B, 12-hr surveys were conducted from 2015 to 2018, whereas 6-hr surveys were conducted from 2019 to 2022. 12-hr surveys in 2016 and 2018 indicated that hourly counts of hatchlings reached greatest in the first 6 hrs, especially 3-4 hrs from the beginning of each survey (2100-2200) and declined subsequently (Figure \@ref(fig:Figure-sector-B)). In other years (e.g., 2015 and 2017), no obvious peaks were observed, although the counts were higher during the first half of survey than the latter half. 


```{r Figure-sector-B, echo=FALSE, message=FALSE, fig.cap="The number of hatchlings per meter at sector B."}

knitr::include_graphics(paste0("figures/sector_B_", dpi.set, "dpi.png"))

```


## Sector D {-}

```{r sector-D, echo=FALSE, message=FALSE, warning=FALSE}

data.1 %>% filter(sector == "D") -> data.1.D

p.sector.D.1 <- ggplot(data.1.D) +
  geom_path(aes(x = hr, y = counts_m_NA)) +
  facet_wrap(~year)+ 
  xlab("Hours since 1800") +
  ylab("# hatchlings per meter")

save.fig.fcn(p.sector.D.1, 
             file.name = paste0("figures/sector_D_", dpi.set, "dpi.png"), 
             replace = T, dpi = dpi.set)

```


In sector B, 12-hr surveys were conducted in 2017 and 2018, whereas 6-hr surveys were conducted in 2016, 2019, and 2020. A 12-hr survey in 2017 indicated that hourly counts of hatchlings were greatest in the second hour of the survey (2000) and declined subsequently (Figure \@ref(fig:Figure-sector-D)). In 2018, a peak was observed at the 6th hour (2400). 


```{r Figure-sector-D, echo=FALSE, message=FALSE, fig.cap="The number of hatchlings per meter at sector D."}

knitr::include_graphics(paste0("figures/sector_D_", dpi.set, "dpi.png"))

```

## Sector 2014S {-}

```{r sector-2014S, echo=FALSE, message=FALSE, warning=FALSE}

data.1 %>% filter(sector == "2014S") -> data.1.2014S

p.sector.2014S.1 <- ggplot(data.1.2014S) +
  geom_path(aes(x = hr, y = counts_m_NA)) +
  facet_wrap(~year)+ 
  xlab("Hours since 1800") +
  ylab("# hatchlings per meter")


save.fig.fcn(p.sector.2014S.1, 
             file.name = paste0("figures/sector_2014S_", dpi.set, "dpi.png"), 
             replace = T, dpi = dpi.set)
```



In sector 2014S, 12-hr surveys were conducted from 2015 to 2018, whereas 6-hr surveys were conducted from 2019 to 2022 (Figure \@ref(fig:Figure-sector-2014S)).  


```{r Figure-sector-2014S, echo=FALSE, message=FALSE, fig.cap="The number of hatchlings per meter at sector 2014S."}

knitr::include_graphics(paste0("figures/sector_2014S_", dpi.set, "dpi.png"))

```


```{r sector-2017S, echo=FALSE, message=FALSE, warning=FALSE}

data.1 %>% filter(sector == "2017S") -> data.1.2017S

p.sector.2017S.1 <- ggplot(data.1.2017S) +
  geom_path(aes(x = hr, y = counts_m_NA)) +
  facet_wrap(~year)+ 
  xlab("Hours since 1800") +
  ylab("# hatchlings per meter")


save.fig.fcn(p.sector.2017S.1, 
             file.name = paste0("figures/sector_2017S_", dpi.set, "dpi.png"), 
             replace = T, dpi = dpi.set)
```

```{r sector-2019S, echo=FALSE, message=FALSE, warning=FALSE}

data.1 %>% filter(sector == "2019S") -> data.1.2019S

p.sector.2019S.1 <- ggplot(data.1.2019S) +
  geom_path(aes(x = hr, y = counts_m_NA)) +
  facet_wrap(~year)+ 
  xlab("Hours since 1800") +
  ylab("# hatchlings per meter")


save.fig.fcn(p.sector.2019S.1, 
             file.name = paste0("figures/sector_2019S_", dpi.set, "dpi.png"), 
             replace = T, dpi = dpi.set)
```

```{r sector_2019N, echo=FALSE, message=FALSE, warning=FALSE}

data.1 %>% filter(sector == "2019N") -> data.1.2019N

p.sector.2019N.1 <- ggplot(data.1.2019N) +
  geom_path(aes(x = hr, y = counts_m_NA)) +
  facet_wrap(~year)+ 
  xlab("Hours since 1800") +
  ylab("# hatchlings per meter")


save.fig.fcn(p.sector.2019N.1, 
             file.name = paste0("figures/sector_2019N_", dpi.set, "dpi.png"), 
             replace = T, dpi = dpi.set)
```

It appears that more hatchlings are generally found before midnight. Look at the ratio between the first and second half of sampling.

```{r first-vs-second, echo=FALSE, message=FALSE, warning=FALSE}

# filter out 12-hr data:
data.1 %>% 
  filter(survey_duration_hr == 12) -> data.1.12hr

# First half
data.1.12hr %>%
  filter(hr < 7) %>%
  group_by(sector, year, date) %>%
  summarize(across(.cols = counts_m, 
                   .fns = sum, 
                   na.rm = T, .names = "counts_m_1")) -> sum.0.6.hrs.12hr

# Second half
data.1.12hr %>%
  filter(hr > 6) %>%
  group_by(sector, year, date) %>%
  summarize(across(.cols = counts_m, 
                   .fns = sum, 
                   na.rm = T, .names = "counts_m_2")) -> sum.7.12.hrs.12hr

# put them together and compute the ratio
sum.0.6.hrs.12hr %>% 
  left_join(sum.7.12.hrs.12hr, by = c("sector", "year", "date")) %>% 
  mutate(ratio = counts_m_1/(counts_m_1 + counts_m_2))-> counts.1st.2nd


p.ratio.sector <- ggplot(data = counts.1st.2nd) +
  geom_point(aes(x = date, y = ratio)) +
  facet_wrap(~sector)


save.fig.fcn(p.ratio.sector, 
             file.name = paste0("figures/ratio_sector_", dpi.set, "dpi.png"), 
             replace = T, dpi = dpi.set)

```

Look at variability among years within each sector

```{r}

counts.1st.2nd %>%
  group_by(sector, year) %>%
  summarise(var = var(ratio),
            mean = mean(ratio)) -> year.sector.var.mean

```

```{r}
p.ratio.year <- ggplot(data = counts.1st.2nd) +
  geom_point(aes(x = sector, y = ratio)) +
  facet_wrap(~year)

save.fig.fcn(p.ratio.year, 
             file.name = paste0("figures/ratio_year_", dpi.set, "dpi.png"), 
             replace = T, dpi = dpi.set)

```

These plots show that variability in the ratio is smaller among sectors within a year than among years within each sector.

Within year Means with 12-hr surveys

```{r}

counts.1st.2nd %>%
  group_by(year) %>%
  summarise(var = var(ratio),
            mean = mean(ratio)) -> year.var.mean.ratio.12hr


```

Within year means with 6-hr surveys

```{r}
# filter out 6-hr data:
data.1 %>% 
  filter(survey_duration_hr == 6, hr < 7) %>%
  group_by(sector, year, date) %>%
  summarize(across(.cols = counts_m, 
                   .fns = sum, 
                   na.rm = T, .names = "counts_m_1")) -> sum.0.6.hrs.6hr


sum.0.6.hrs.6hr %>%
  group_by(year) %>%
  summarise(var = var(counts_m_1),
            mean = mean(counts_m_1)) -> year.var.mean.6hr

# Combine with 12hr dataset:
sum.6hr <- rbind(sum.0.6.hrs.12hr, sum.0.6.hrs.6hr)

p.counts.first.6hr <- ggplot(data = sum.6hr) +
  geom_point(aes(x = sector, y = counts_m_1)) +
  facet_wrap(~year)

save.fig.fcn(p.counts.first.6hr, 
             file.name = paste0("figures/counts_6hr_all_", dpi.set, "dpi.png"), 
             replace = T, dpi = dpi.set)

```
