---
title: "Hatchling counts at Raine Island"
author: "Tomo Eguchi"
date: "`r Sys.Date()`"
output: 
  bookdown::word_document2: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

# # remove all pakcages - detach() removes the first one.
# loaded.packages <- (.packages())
# if (length(loaded.packages > 0)){
#   for (k in 1:length(loaded.packages)){
#     detach()
#   }
# }

rm(list = ls())
library(tidyverse)
library(readr)
library(flextable)
library(cowplot)
library(lubridate)

set_flextable_defaults(font.size = 9,
                       font.family = "Cambria")

save.fig.fcn <- function(fig, file.name, replace = F, dpi = 600, device = "png",
                         height = 4, 
                         width = 6, 
                         units = "in",
                         bg = "white"){
  if (isTRUE(replace) | (!isTRUE(replace) & !file.exists(file.name)))
    ggsave(fig, 
           filename = file.name, 
           dpi = dpi, device = device,
           height = height, width = width, units = units,
           bg = bg)
  
}

save.fig <- T
dpi.set <- 600

```

## Background {-}

At Raine Island, annual hatchling production has been determined via counts of hatchlings on the beach. Observers are stationed at multiple sectors, where they count hatchlings that come down the beach. A trench is dug and all hatchlings that fall into the trench are counted and released hourly. During the 2018-2019 season, the survey was changed from 12 hrs (1800 to 0600) to 6 hrs (1800 - 0000) for logistical reasons. 

In order to look at possible effects of differences in sampling scheme (i.e., 12hr vs 6 hr), I compare hatchling count data between the two sampling design. I converted the counts to counts per meter using the length of a trench (50 m vs 100 m). All analyses were conducted on the number of observed hatchlings per meter per hour. Furthermore, in order to consider the differences in the number of nesting females per nesting season, I divided the number of hatchlings per meter per hour by the estimated number of females (Petersen estimates from vessel-based survey) divided by 1000. The unit of the variable of interest, therefore, is the number of hatchlings per meter per hour per 1000 females. 

```{r data-import, include=FALSE, echo=FALSE, message=FALSE, warning=FALSE}

col.def <- cols(date = col_date(format = "%d/%m/%Y"),
                sector = col_factor(levels = c("A", "A2", "B", "D", "2014S", "2017S", "2019S", "2019N")),
                island = col_character(),
                trench_length_m = col_double(), 
                survey_length = col_character(), 
                total_before_1800 = col_integer(), 
                total_1800_1900 = col_integer(), 
                total_1900_2000 = col_integer(), 
                total_2000_2100 = col_integer(),
                total_2100_2200 = col_integer(),
                total_2200_2300 = col_integer(),
                total_2300_2400 = col_integer(),
                total_2400_0100 = col_integer(),
                total_0100_0200 = col_integer(), 
                total_0200_0300 = col_integer(),
                total_0300_0400 = col_integer(),
                total_0400_0500 = col_integer(),
                total_0500_0600 = col_integer(),
                total_after_0600 = col_integer(),
                nightly_total = col_integer())

data.0 <- read_csv(file = "data/hatch_count_fullcount_2014-15-2021-22.csv",
                   col_types = col.def) %>% 
  discard(~ all(is.na(.))) %>%
  mutate(survey_duration_hr = ifelse(survey_length == "12hr", 12, 6)) %>%
  mutate(year = lubridate::year(date),
         month = lubridate::month(date),
         date_num = as.numeric(date)) 


data.0 %>%
  select(-c("survey_length", "nightly_total")) %>%
  pivot_longer(data.0,
               cols = starts_with("total"),
               names_to = "time",
               values_to = "counts") %>%
  mutate(hr = ifelse(time == "total_before_1800", 0,
                     ifelse(time == "total_1800_1900", 1,
                            ifelse(time == "total_1900_2000", 2,
                                   ifelse(time == "total_2000_2100", 3,
                                          ifelse(time == "total_2100_2200", 4,
                                                 ifelse(time == "total_2200_2300", 5,
                                                        ifelse(time == "total_2300_2400", 6,
                                                               ifelse(time == "total_2400_0100", 7,
                                                                      ifelse(time == "total_0100_0200", 8,
                                                                             ifelse(time == "total_0200_0300", 9,
                                                                                    ifelse(time == "total_0300_0400", 10,
                                                                                           ifelse(time == "total_0400_0500", 11,
                                                                                                  ifelse(time == "total_0500_0600", 12, 13)))))))))))))) %>%
  mutate(counts_m = counts/trench_length_m) %>%
  mutate(counts_m_NA = ifelse((survey_duration_hr == 6 & hr > 6), NA, counts_m)) -> data.1


# Ballpark figures of nesting female abundance - extracted from Figure 2 of Raine Island Recovery Project 2021-22 Technical report.pdf. - To be updated with more precise numbers. 

n.females.df <- data.frame(year = c(2015:2022),
                           n.females = c(15000, 5000, 12000, 20000, 1000, 38000, 1000, 12000))

# combine the # females into the data
data.1 %>% left_join(n.females.df, by = "year") %>%
  mutate(counts_m_NA_female = 1000 * counts_m_NA/n.females) -> data.1

p.females <- ggplot(n.females.df) +
  geom_point(aes(x = year, y = n.females/1000), size = 2) +
  xlab("") + ylab("Estimated number of females (1000s)")

save.fig.fcn(p.females, 
             file.name = paste0("figures/females_", dpi.set, "dpi.png"), 
             replace = T, dpi = dpi.set)

```




```{r pivot-check, message=FALSE, echo=FALSE, warning=FALSE}
# Make sure the pivoting worked correctly:

data.0 %>% 
  filter(year == 2020, sector == "A") %>%
  mutate(date.f = as.factor(date)) %>%
  group_by(date.f) %>%
  rowwise() %>%
  mutate(daily.sum = sum(c_across(starts_with("total")))) -> data.0.A.2020.daily.sum


data.1 %>% 
  filter(year == 2020, sector == "A") %>%
  mutate(date.f = as.factor(date)) %>%
  group_by(date.f) %>%
  summarize(daily.sum = sum(counts, na.rm = T)) -> data.1.A.2020.daily.sum


data.0 %>% 
  filter(year == 2015, sector == "2014S") %>%
  mutate(date.f = as.factor(date)) %>%
  group_by(date.f) %>%
  rowwise() %>%
  mutate(daily.sum = sum(c_across(starts_with("total")), na.rm = T)) -> data.0.2014S.2015.daily.sum


data.1 %>% 
  filter(year == 2015, sector == "2014S") %>%
  mutate(date.f = as.factor(date)) %>%
  group_by(date.f) %>%
  summarize(daily.sum = sum(counts, na.rm = T)) -> data.1.2014S.2015.daily.sum

# Two sets are the same so I assume that the pivoting operations worked fine to convert the wide format to long format.

```

In general, greater numbers of hatchlings were counted before midnight (6hrs since 1800) than after. The observed number of hatchlings ranged from `r signif(min(data.1$counts_m_NA, na.rm=T), 2)` to `r signif(max(data.1$counts_m_NA, na.rm=T), 2)` per meter per hour. When these numbers were standardized for the estimated number of adult females (in 1000s; Figure \@ref(fig:Figure-females)), they ranged from `r signif(min(data.1$counts_m_NA_female, na.rm=T), 2)` to `r signif(max(data.1$counts_m_NA_female, na.rm=T), 2)` per meter per hour per 1000 adult females (Figure \@ref(fig:Figure-raw-counts)).


```{r Figure-females, echo=FALSE, message=FALSE, fig.cap="The estimated number of females per year from vessel-based Petersen estimates"}

knitr::include_graphics(paste0("figures/females_", dpi.set, "dpi.png"))

```

In order to look at the details, each sector was examined separately. 

```{r raw-plot, echo=FALSE, message=FALSE, warning=FALSE}
p.raw.counts <- ggplot(data = data.1) +
  # geom_point(aes(x = hr, 
  #                y = counts, 
  #                color = sector)) +
  geom_path(aes(x = hr, 
                 y = counts_m_NA, 
                 color = as.factor(year))) +
  facet_wrap(~sector, nrow = 2) +
  labs(color = "Year") +
  theme(legend.position = "none") +
  xlab("Hours since 1800") + ylab("# hatchlings per meter")


p.raw.counts.per.female <- ggplot(data = data.1) +
  # geom_point(aes(x = hr, 
  #                y = counts, 
  #                color = sector)) +
  geom_path(aes(x = hr, 
                 y = counts_m_NA_female, 
                 color = as.factor(year))) +
  facet_wrap(~sector, nrow = 2) +
  labs(color = "Year") +
  xlab("Hours since 1800") + ylab("# hatchlings per meter per 1000 females")

p.counts <- plot_grid(p.raw.counts, p.raw.counts.per.female,
                      labels = c("(1)", "(2)"))

save.fig.fcn(p.counts, 
             file.name = paste0("figures/raw_counts_", dpi.set, "dpi.png"), 
             replace = T, dpi = dpi.set)

```


```{r Figure-raw-counts, echo=FALSE, message=FALSE, fig.cap="The number of hatchlings per meter at 8 sectors."}

knitr::include_graphics(paste0("figures/raw_counts_", dpi.set, "dpi.png"))

```

## Sector-specific pattern {-}

### Sector A {-}

```{r sector-A, echo=FALSE, message=FALSE, warning=FALSE}
xlab.txt <- "Hours since 1800"
ylab.1.txt <- "# hatchlings per meter"
ylab.2.txt <- "# hatchlings per meter per 1000 females"

data.1 %>% filter(sector == "A") -> data.1.A

p.sector.A <- ggplot(data.1.A) +
  geom_path(aes(x = hr, y = counts_m_NA)) +
  facet_wrap(~year) + 
  xlab(xlab.txt) +
  ylab(ylab.1.txt)

p.sector.A.female <- ggplot(data.1.A) +
  geom_path(aes(x = hr, y = counts_m_NA_female)) +
  facet_wrap(~year) + 
  xlab(xlab.txt) +
  ylab(ylab.2.txt)

p.sector.A.1 <- plot_grid(p.sector.A, p.sector.A.female,
                          labels = c("(1)", "(2)"))

save.fig.fcn(p.sector.A.1, 
             file.name = paste0("figures/sector_A_", dpi.set, "dpi.png"), 
             replace = T, dpi = dpi.set)

```

At sector A, only 6-hr surveys were conducted in `r min(data.1.A$year)` - `r max(data.1.A$year)`. The observed variability among surveys in 2020 was large (Figure \@ref(fig:Figure-sector-A)). In 2021, even though the number of hatchlings was low, the number of hatchligs per 1000 females was higher than the other two years (Figure \@ref(fig:Figure-sector-A)), indicating a negative relationship between hatching success rates and the number of females. 


```{r Figure-sector-A, echo=FALSE, message=FALSE, fig.cap="The number of hatchlings per meter (1) and the number of hatchlings per meter per 1000 females (2) at sector A."}

knitr::include_graphics(paste0("figures/sector_A_", dpi.set, "dpi.png"))

```


### Sector A2 {-}

```{r sector-A2, echo=FALSE, message=FALSE, warning=FALSE}

data.1 %>% filter(sector == "A2") -> data.1.A2

p.sector.A2 <- ggplot(data.1.A2) +
  geom_path(aes(x = hr, y = counts_m_NA)) +
  facet_wrap(~year)+ 
  xlab(xlab.txt) +
  ylab(ylab.1.txt) +
  theme(legend.position = "none")

p.sector.A2.female <- ggplot(data.1.A2) +
  geom_path(aes(x = hr, y = counts_m_NA_female)) +
  facet_wrap(~year)+ 
  xlab(xlab.txt) +
  ylab(ylab.2.txt)

p.sector.A2.1 <- plot_grid(p.sector.A2, p.sector.A2.female,
                          labels = c("(1)", "(2)"))

save.fig.fcn(p.sector.A2.1, 
             file.name = paste0("figures/sector_A2_", dpi.set, "dpi.png"), 
             replace = T, dpi = dpi.set)

```

In sector A2, 12-hr surveys were conducted from 2015 to 2018, whereas 6-hr surveys were conducted in 2019. 12-hr surveys indicated that hourly counts of hatchlings reached greatest in the first 6 hrs, especially 3-4 hrs from the beginning of each survey (2100-2200) and declined subsequently (Figure \@ref(fig:Figure-sector-A2)).


```{r Figure-sector-A2, echo=FALSE, message=FALSE, fig.cap="The number of hatchlings per meter (1) and the number of hatchlings per meter per 1000 females (2) at sector A2."}

knitr::include_graphics(paste0("figures/sector_A2_", dpi.set, "dpi.png"))

```

### Sector B {-}

```{r sector-B, echo=FALSE, message=FALSE, warning=FALSE}

data.1 %>% filter(sector == "B") -> data.1.B

p.sector.B <- ggplot(data.1.B) +
  geom_path(aes(x = hr, y = counts_m_NA)) +
  facet_wrap(~year)+ 
  xlab(xlab.txt) +
  ylab(ylab.1.txt) 

p.sector.B.female <- ggplot(data.1.B) +
  geom_path(aes(x = hr, y = counts_m_NA_female)) +
  facet_wrap(~year)+ 
  xlab(xlab.txt) +
  ylab(ylab.2.txt) 

p.sector.B.1 <- plot_grid(p.sector.B, p.sector.B.female,
                          labels = c("(1)", "(2)"))

save.fig.fcn(p.sector.B.1, 
             file.name = paste0("figures/sector_B_", dpi.set, "dpi.png"), 
             replace = T, dpi = dpi.set)

```


In sector B, 12-hr surveys were conducted from 2015 to 2018, whereas 6-hr surveys were conducted from 2019 to 2022. 12-hr surveys in 2016 and 2018 indicated that hourly counts of hatchlings reached greatest in the first 6 hrs, especially 3-4 hrs from the beginning of each survey (2100-2200) and declined subsequently (Figure \@ref(fig:Figure-sector-B)). In other years (e.g., 2015 and 2017), no obvious peaks were observed, although the counts were higher during the first half of survey than the latter half. 


```{r Figure-sector-B, echo=FALSE, message=FALSE, fig.cap="The number of hatchlings per meter (1) and the number of hatchlings per meter per 1000 females (2) at sector B."}

knitr::include_graphics(paste0("figures/sector_B_", dpi.set, "dpi.png"))

```


### Sector D {-}

```{r sector-D, echo=FALSE, message=FALSE, warning=FALSE}

data.1 %>% filter(sector == "D") -> data.1.D

p.sector.D <- ggplot(data.1.D) +
  geom_path(aes(x = hr, y = counts_m_NA)) +
  facet_wrap(~year)+ 
  xlab(xlab.txt) +
  ylab(ylab.1.txt)


p.sector.D.female <- ggplot(data.1.D) +
  geom_path(aes(x = hr, y = counts_m_NA_female)) +
  facet_wrap(~year)+ 
  xlab(xlab.txt) +
  ylab(ylab.1.txt)

p.sector.D.1 <- plot_grid(p.sector.D, p.sector.D.female,
                          labels = c("(1)", "(2)"))

save.fig.fcn(p.sector.D.1, 
             file.name = paste0("figures/sector_D_", dpi.set, "dpi.png"), 
             replace = T, dpi = dpi.set)

```


In sector D, 12-hr surveys were conducted in 2017 and 2018, whereas 6-hr surveys were conducted in 2016, 2019, and 2020. A 12-hr survey in 2017 indicated that hourly counts of hatchlings were greatest in the second hour of the survey (2000) and declined subsequently (Figure \@ref(fig:Figure-sector-D)). In 2018, a peak was observed at the 6th hour (2400). 


```{r Figure-sector-D, echo=FALSE, message=FALSE, fig.cap="The number of hatchlings per meter (1) and the number of hatchlings per meter per 1000 females (2) at sector D."}

knitr::include_graphics(paste0("figures/sector_D_", dpi.set, "dpi.png"))

```

### Sector 2014S {-}

```{r sector-2014S, echo=FALSE, message=FALSE, warning=FALSE}

data.1 %>% filter(sector == "2014S") -> data.1.2014S

p.sector.2014S <- ggplot(data.1.2014S) +
  geom_path(aes(x = hr, y = counts_m_NA)) +
  facet_wrap(~year)+ 
  xlab(xlab.txt) +
  ylab(ylab.1.txt)

p.sector.2014S.female <- ggplot(data.1.2014S) +
  geom_path(aes(x = hr, y = counts_m_NA_female)) +
  facet_wrap(~year)+ 
  xlab(xlab.txt) +
  ylab(ylab.2.txt)

p.sector.2014S.1 <- plot_grid(p.sector.2014S, p.sector.2014S.female,
                          labels = c("(1)", "(2)"))

save.fig.fcn(p.sector.2014S.1, 
             file.name = paste0("figures/sector_2014S_", dpi.set, "dpi.png"), 
             replace = T, dpi = dpi.set)
```


In sector 2014S, 12-hr surveys were conducted from 2015 to 2018, whereas 6-hr surveys were conducted from 2019 to 2022 (Figure \@ref(fig:Figure-sector-2014S)). Higher counts were recorded in the first half (1800-2400) of the night.  


```{r Figure-sector-2014S, echo=FALSE, message=FALSE, fig.cap="The number of hatchlings per meter (1) and the number of hatchlings per meter per 1000 females (2) at sector 2014S."}

knitr::include_graphics(paste0("figures/sector_2014S_", dpi.set, "dpi.png"))

```

### Sector 2017S {-}
```{r sector-2017S, echo=FALSE, message=FALSE, warning=FALSE}

data.1 %>% filter(sector == "2017S") -> data.1.2017S

p.sector.2017S <- ggplot(data.1.2017S) +
  geom_path(aes(x = hr, y = counts_m_NA)) +
  facet_wrap(~year)+ 
  xlab(xlab.txt) +
  ylab(ylab.1.txt)

p.sector.2017S.female <- ggplot(data.1.2017S) +
  geom_path(aes(x = hr, y = counts_m_NA_female)) +
  facet_wrap(~year)+ 
  xlab(xlab.txt) +
  ylab(ylab.2.txt)

p.sector.2017S.1 <- plot_grid(p.sector.2017S, p.sector.2017S.female,
                          labels = c("(1)", "(2)"))

save.fig.fcn(p.sector.2017S.1, 
             file.name = paste0("figures/sector_2017S_", dpi.set, "dpi.png"), 
             replace = T, dpi = dpi.set)
```

In sector 2017S, 12-hr surveys were conducted in 2018, whereas 6-hr surveys were conducted from 2019 to 2021 (Figure \@ref(fig:Figure-sector-2017S)). Counts from 2018 indicated that the number of hatchlings was greater before the midnight than after. No apparent peaks were found for 2019, 2020, or 2021.  


```{r Figure-sector-2017S, echo=FALSE, message=FALSE, fig.cap="The number of hatchlings per meter (1) and the number of hatchlings per meter per 1000 females (2) at sector 2017S."}

knitr::include_graphics(paste0("figures/sector_2017S_", dpi.set, "dpi.png"))

```

### Sector 2019S {-}
```{r sector-2019S, echo=FALSE, message=FALSE, warning=FALSE}

data.1 %>% filter(sector == "2019S") -> data.1.2019S

p.sector.2019S <- ggplot(data.1.2019S) +
  geom_path(aes(x = hr, y = counts_m_NA)) +
  facet_wrap(~year)+ 
  xlab(xlab.txt) +
  ylab(ylab.1.txt)

p.sector.2019S.female <- ggplot(data.1.2019S) +
  geom_path(aes(x = hr, y = counts_m_NA_female)) +
  facet_wrap(~year)+ 
  xlab(xlab.txt) +
  ylab(ylab.2.txt)

p.sector.2019S.1 <- plot_grid(p.sector.2019S, p.sector.2019S.female,
                          labels = c("(1)", "(2)"))

save.fig.fcn(p.sector.2019S.1, 
             file.name = paste0("figures/sector_2019S_", dpi.set, "dpi.png"), 
             replace = T, dpi = dpi.set)
```

In Sector 2019S, only 6-hr surveys were conducted. An apparent peak at 2 hrs after 1800 (2000) was observed for 2022, whereas the timing of the peak for 2020 was inconclusive between the two surveys. No apparent peak was observed for 2021 (Figure \@ref(fig:Figure-sector-2019S)). 

```{r Figure-sector-2019S, echo=FALSE, message=FALSE, fig.cap="The number of hatchlings per meter (1) and the number of hatchlings per meter per 1000 females (2) at sector 2019S."}

knitr::include_graphics(paste0("figures/sector_2019S_", dpi.set, "dpi.png"))

```

### Sector 2019N {-}
```{r sector_2019N, echo=FALSE, message=FALSE, warning=FALSE}

data.1 %>% filter(sector == "2019N") -> data.1.2019N

p.sector.2019N <- ggplot(data.1.2019N) +
  geom_path(aes(x = hr, y = counts_m_NA)) +
  facet_wrap(~year)+ 
  xlab(xlab.txt) +
  ylab(ylab.1.txt)

p.sector.2019N.female <- ggplot(data.1.2019N) +
  geom_path(aes(x = hr, y = counts_m_NA_female)) +
  facet_wrap(~year)+ 
  xlab(xlab.txt) +
  ylab(ylab.2.txt)

p.sector.2019N.1 <- plot_grid(p.sector.2019N, p.sector.2019N.female,
                          labels = c("(1)", "(2)"))

save.fig.fcn(p.sector.2019N.1, 
             file.name = paste0("figures/sector_2019N_", dpi.set, "dpi.png"), 
             replace = T, dpi = dpi.set)
```

In sector 2019N, a peak was observed at 2-3 hrs after 1800 (2000-2100) in 2022 (Figure \@ref(fig:Figure-sector-2019N)).

```{r Figure-sector-2019N, echo=FALSE, message=FALSE, fig.cap="The number of hatchlings per meter (1) and the number of hatchlings per meter per 1000 females (2) at sector 2019N."}

knitr::include_graphics(paste0("figures/sector_2019N_", dpi.set, "dpi.png"))

```

## Estimating counts for 12-hr from 6-hr sampling {-}

It appears that more hatchlings are generally found before midnight. An objective of this project is to estimate the total number of hatchlings per night (1800 - 0600) from a reduced sampling design that counted the number of hatchlings in 6-hr period (1800 - 2400). Two approaches were used to estimate the total counts from partial counts: (1) using the ratios between the first and second half and (2) develop a regression model to determine the relationship between the first and second halves.

### Ratios between the two sampling periods (1800-0600 vs. 1800-2400)

```{r first-vs-second, echo=FALSE, message=FALSE, warning=FALSE}

calculate.ratio <- function(data.1){
  
  # filter out 12-hr data:
  data.1 %>% 
    filter(survey_duration_hr == 12) -> data.1.12hr

  # Create a sequential ID number for each survey
  # date_num_df <- data.frame(date_num = unique(data.1.12hr$date_num),
  #                           date_seq = 1:length(unique(data.1.12hr$date_num)))
  # 
  # data.1.12hr %>%
  #   left_join(date_num_df, by = "date_num") -> data.1.12hr
  # 
  # 
  # First half
  data.1.12hr %>%
    filter(hr < 7) %>%
    group_by(sector, year, date) %>%
    select(sector, year, date, counts, trench_length_m, date_num) %>% #-> tmp.1
    summarize(across(.cols = counts, 
                     .fns = sum, 
                     na.rm = T, 
                     .names = "counts_1"),
              length = first(trench_length_m),
              date_num = first(date_num)) -> sum.0.6.hrs.12hr
  
  data.1.12hr %>%
    filter(hr < 7) %>%
    group_by(sector, year, date) %>%
    summarize(across(.cols = counts_m, 
                     .fns = sum, 
                     na.rm = T, 
                     .names = "counts_m_1")) -> counts.m.1
  
  sum.0.6.hrs.12hr$counts_m_1 <- counts.m.1$counts_m_1
  
  # Second half
  data.1.12hr %>%
    filter(hr > 6) %>%
    group_by(sector, year, date) %>%
    summarize(across(.cols = counts, 
                     .fns = sum, 
                     na.rm = T, 
                     .names = "counts_2")) -> sum.7.12.hrs.12hr
  
  data.1.12hr %>%
    filter(hr > 6) %>%
    group_by(sector, year, date) %>%
    summarize(across(.cols = counts_m, 
                     .fns = sum, 
                     na.rm = T, .names = "counts_m_2")) -> counts.m.2
  
  sum.7.12.hrs.12hr$counts_m_2 <- counts.m.2$counts_m_2
  
  # put them together and compute the ratio
  sum.0.6.hrs.12hr %>% 
    left_join(sum.7.12.hrs.12hr, by = c("sector", "year", "date")) %>% 
    mutate(ratio = counts_m_1/(counts_m_1 + counts_m_2))-> counts.1st.2nd
  
  return(counts.1st.2nd)  
}

counts.1st.2nd <- calculate.ratio(data.1)

p.ratio.sector <- ggplot(data = counts.1st.2nd) +
  geom_point(aes(x = date, y = ratio)) +
  facet_wrap(~sector)


save.fig.fcn(p.ratio.sector, 
             file.name = paste0("figures/ratio_sector_", dpi.set, "dpi.png"), 
             replace = T, dpi = dpi.set)

```

The proportion of hatchlings that were counted during the first 6 hrs, i.e., 1800 to 2400, relative to the 12-hr period (1800-0600) ranged from `r signif(min(counts.1st.2nd$ratio), 3)` to `r signif(max(counts.1st.2nd$ratio), 3)`. Majority of them were greater than 0.5 (`r counts.1st.2nd %>% filter(ratio > 0.5) %>% nrow()` of `r nrow(counts.1st.2nd`), mean = `r signif(mean(counts.1st.2nd$ratio), 3)`, SE = `r signif(sqrt(var(counts.1st.2nd$ratio))/sqrt(nrow(counts.1st.2nd)), 3)`). Two counts that resulted in low proportions of hatchlings during the first half of the evenings occurred in 2018 in sector A2 (Figure \@ref(fig:)).


```{r Figure-ratio-sectors, echo=FALSE, message=FALSE, fig.cap="The proportion of hatchlings per meter during the first half of the evening (1800-2400) in the total number of hatchlings (1800-0600)."}

knitr::include_graphics(paste0("figures/ratio_sector_", dpi.set, "dpi.png"))

```

```{r sector-year-summary, echo=FALSE, message=FALSE}

# counts.1st.2nd %>%
#   group_by(sector, year) %>%
#   summarise(var = var(ratio),
#             mean = mean(ratio)) -> year.sector.var.mean
# 

counts.1st.2nd %>%
  group_by(year,sector) %>%
  summarize(mean.ratio = mean(ratio),
            SE.ratio = sqrt(var(ratio))/sqrt(n()),
            n = n()) -> counts.1st.2nd.means

counts.1st.2nd %>%
  group_by(year) %>%
  summarise(mean.sectors = mean(ratio),
            SE.sectors = sqrt(var(ratio))/sqrt(n())) -> counts.1st.2nd.sectors

counts.1st.2nd %>%
  group_by(sector) %>%
  summarise(mean.years = mean(ratio),
            SE.years = sqrt(var(ratio))/sqrt(n())) -> counts.1st.2nd.years


```

```{r}
p.ratio.year <- ggplot(data = counts.1st.2nd) +
  geom_point(aes(x = sector, y = ratio)) +
  facet_wrap(~year)

save.fig.fcn(p.ratio.year, 
             file.name = paste0("figures/ratio_year_", dpi.set, "dpi.png"), 
             replace = T, dpi = dpi.set)

```

These plots show that variability in the ratio is smaller among sectors within a year than among years within each sector, except 2018 in sector A2 (Figure \@ref(fig:Figure-ratio-years)). Standard errors within year ranged from `r signif(min(counts.1st.2nd.sectors$SE.sectors), 3)` to `r signif(max(counts.1st.2nd.sectors$SE.sectors), 3)`, whereas those within sector ranged from `r signif(min(counts.1st.2nd.years$SE.years), 3)` to `r signif(max(counts.1st.2nd.years$SE.years), 3)`.


```{r Figure-ratio-years, echo=FALSE, message=FALSE, fig.cap="The proportion of hatchlings per meter during the first half of the evening (1800-2400) in the total number of hatchlings (1800-0600) within each sector."}

knitr::include_graphics(paste0("figures/ratio_year_", dpi.set, "dpi.png"))

```

Cross validations were conducted for all date- and sector-specific surveys that were 12 hr long. The second half of each survey was computed using the first half of the survey and the proportion of the first half that was computed using either (1) only the same sector for that year, (2) all sectors for that year, (3) all other sectors for that year, or (4) all sectors from other years. 

```{r cross-validation-1, echo=FALSE, message=FALSE}
compute.2nd <- function(m.1st, mean.ratio){
  m.2nd <- ((1/mean.ratio) - 1) * m.1st 
}

# Only 12-hr surveys are used in this exercise:
data.1 %>% filter(survey_duration_hr > 6) -> data.1.12hr
counts.1st.2nd.12hr <- calculate.ratio(data.1.12hr)

# Create a sequential ID number for each survey 
date_num_df <- data.frame(date_num = unique(data.1.12hr$date_num),
                          date_seq = 1:length(unique(data.1.12hr$date_num)))

data.1.12hr %>%
  left_join(date_num_df, by = "date_num") -> data.1.12hr

data.out <- counts.1st.2nd.12hr
data.out$estim.1 <-  NA
data.out$estim.all <- NA
data.out$estim.others <- NA
data.out$estim.other.yrs <- NA

# first, I use all surveys except one. 
n.surveys <- length(unique(data.1.12hr$date_seq))

k <- 1
for (k in 1:n.surveys){
  data.1.k <- data.1.12hr %>% filter(date_seq == k)
  counts.1st.2nd.k <- calculate.ratio(data.1.k)
  
  year.k <- counts.1st.2nd.k$year[1]
  date.k <- counts.1st.2nd.k$date[1]
  
  data.1.1 <- data.1.12hr %>% filter(date_seq != k, year == year.k)
  counts.1st.2nd.1 <- calculate.ratio(data.1.1)
  
  # data from other years
  data.1.other.years  <- data.1.12hr %>% filter(year != year.k)
  counts.1st.2nd.other.years <- calculate.ratio(data.1.other.years)
  mean.other.years <- mean(counts.1st.2nd.other.years$ratio)

  # use the same sector or use all or all other:
  k1 <- 2
  for (k1 in 1:nrow(counts.1st.2nd.k)){
    
    sector.1 <- counts.1st.2nd.k$sector[k1] %>% as.character()
    m.1st <- counts.1st.2nd.k$counts_m_1[k1]
    
    # same sector:
    counts.1st.2nd.1 %>%
      filter( sector == sector.1) -> ratio.1.sector
    
    # other sectors
    counts.1st.2nd.1 %>%
      filter(sector != sector.1) -> ratio.other.sectors
      
    mean.1.sector <- mean(ratio.1.sector$ratio)
    mean.all.sectors <- mean(counts.1st.2nd.1$ratio)
    mean.other.sectors <- mean(ratio.other.sectors$ratio)
    
    data.out[data.out$sector == sector.1 & 
               data.out$date == date.k, "estim.1"] <- compute.2nd(m.1st, mean.1.sector)
    data.out[data.out$sector == sector.1 & 
               data.out$date == date.k, "estim.all"] <- compute.2nd(m.1st, mean.all.sectors)
    data.out[data.out$sector == sector.1 & 
               data.out$date == date.k, "estim.others"] <- compute.2nd(m.1st, mean.other.sectors)
    data.out[data.out$sector == sector.1 & 
               data.out$date == date.k, "estim.other.yrs"] <- compute.2nd(m.1st, mean.other.years)
  }

}

data.out %>%
  mutate(dif.1 = estim.1 - counts_m_2,
         dif.all = estim.all - counts_m_2,
         dif.others = estim.others - counts_m_2,
         dif.other.yrs = estim.other.yrs - counts_m_2) -> data.out

p.estimates.1 <- ggplot(data = data.out) +
  geom_jitter(aes(x = sector, 
                  y = dif.1), 
              color = "orange", size = 2,
              width = 0.2, height = 0) +
  geom_jitter(aes(x = sector, y = dif.all), 
              color = "purple", size = 2,
              width = 0.2, height = 0) +
  geom_jitter(aes(x = sector, y = dif.others), 
              color = "red", size = 2,
              width = 0.2, height = 0) +
  geom_jitter(aes(x = sector, y = dif.other.yrs), 
              color = "yellow", size = 2,
              width = 0.2, height = 0) +
  facet_wrap(~ year)

save.fig.fcn(p.estimates.1, 
             file.name = paste0("figures/ratio_estimates_", dpi.set, "dpi.png"), 
             replace = T, dpi = dpi.set)

ratio.summary.table <- data.frame(Sets = c("One sector", "All sectors", "Other sectors", "Other years"),
                                  Mean = c(mean(data.out$dif.1, na.rm = T), mean(data.out$dif.all),
                                           mean(data.out$dif.others), mean(data.out$dif.other.yrs)),
                                  SD = c(sqrt(var(data.out$dif.1, na.rm = T)), sqrt(var(data.out$dif.all)),
                                         sqrt(var(data.out$dif.others)), sqrt(var(data.out$dif.other.yrs))),
                                  min = c(min(data.out$dif.1, na.rm = T), min(data.out$dif.all),
                                           min(data.out$dif.others), min(data.out$dif.other.yrs)),
                                  max = c(max(data.out$dif.1, na.rm = T), max(data.out$dif.all),
                                           max(data.out$dif.others), max(data.out$dif.other.yrs)))

```



```{r Figure-ratio, echo=FALSE, message=FALSE, fig.cap="The differences between the observed and calculated numbers of hatchlings using the ratio between the first and total number of hatchlings. Calculations were conducted in a cross validation manner where each survey was withheld from computing the ratio to be used in calculating the second half of the evening. Colors indicate different sets of data to cross validate: orange = using the same sector within the same year, purple = using all sectors within the same year, red = using other sectors witin the same year, and yellow = using all sectors from other years."}

knitr::include_graphics(paste0("figures/ratio_estimates_", dpi.set, "dpi.png"))

```


The comparison of the calculated values (i.e., hatchling counts during the second half of each survey) indicated that the using all sectors from all other years resulted in smallest variability in the difference between the true and calculated values, followed by using all sectors within the same year (Table \@ref(tab:Table-summary-ratio), Figure \@ref(fig:Figure-ratio)). It is important to note that using all sectors or one sector within the same year requires some 12-hr sampling to be conducted within each year. 


```{r Table-summary-ratio, echo=FALSE, warning=FALSE}
flextable(ratio.summary.table) %>% 
  #hline(i = (nrow(ratio.summary.table)-1)) %>%
 set_caption(paste0("A comparison of data sets for cross validation to calculate the second half of a survey from the first half. Results in the table indicate the differences from the true values.")) %>%
  set_table_properties(width = 0.5, layout = "autofit") %>%
  colformat_double(j = c("Mean", "SD", "min", "max"), digits = 2)

```


### Statistical modeling of hatchling counts {-}

In this section, I use a statistical model to estimate the number of hatchlings during the second half of the night from the first half. I treated the observed number of hatchlings from 1800 to 2400 (n) in the j-th sector of the k-th sampling day during the y-th year as a Poisson random deviate:

$ n_{j, k, y} \sim POI(\lambda_{j, k, y})$. 

The number of hatchlings from 2400 to 0600 (m) is also a Poisson random deviate and its mean is a function of $\lambda_{j,k,y}$ and the proportion of the number of hatchlings from 1800 to 2400 to that from 1800 to 2400 ($p{y}$). I removed the sector- and sampling-day specific subscripts for the proportion because the proportion among sectors within a year was not as variable as among years (Figure \@ref(fig:Figure-ratio-years)):

$ m_{j,k,y} \sim POI(\lambda_{j,k,y} p_{y}) $.

The mean ($\lambda_{j, k, y}$) is a function of covariates (year (Y) and the number of females ($N_{female}$), whereas the sampling day ($D_{j,k,y}$) is a random-effect variable):

$\lambda_{j,k,y} = L_{j,k,y} \times exp(B0 + \beta_1 Y + \beta_2 N_{y} + \beta_3 D_{j,k,y}) $,

where $L_{j,k,y}$ is the trench length of the survey,d $D_{j,k,y} $ is days since December 20th, and $N_y$ is the estimated number of females for the year. 

Using these likelihood functions, I estimated the missing values of $m_{j,k,y}$ in a Bayesian approach. I used the following prior distributions.

$ \lambda_{j,k,y} \sim GAM(0.1, 0.5)$

$ p_y \sim BETA(2, 1)$

The density functions for these prior distributions are shown in Figure X. 

To test the modeling approach, I first used only data with 12-hr sampling and conducted cross-validations by withholding one 2400-0600 period at a time. 


```{r modeling-1, echo=FALSE, message=FALSE}
library("jagsUI")
library("bayesplot")

create.n.m.D.length <- function(n.years, n.sectors, n.days, counts.1st.2nd.jags.data){
  n <- m <- D <- length <- array(dim = c(n.years, max(n.sectors), max(n.days, na.rm = T)))
  n.sectors <- vector(mode = "numeric", 
                      length = length(unique(counts.1st.2nd.jags.data$year_num)))
  
  k1 <- k2 <- k3 <- 1
  for (k1 in 1:n.years){
    counts.1st.2nd.jags.data %>%
      filter(year_num == k1) -> tmp.k1
    n.sectors[k1] <- length(unique(tmp.k1$sector_num))
    sectors.k1 <- unique(tmp.k1$sector_num)
    for (k2 in 1:n.sectors[k1]){
      tmp.k1 %>% 
        filter(sector_num == sectors.k1[k2]) -> tmp
      for (k3 in 1:n.days[k1, k2]){
        n[k1, sectors.k1[k2], k3] <- tmp$counts_1[k3]
        m[k1, sectors.k1[k2], k3] <- tmp$counts_2[k3]
        D[k1, sectors.k1[k2], k3] <- tmp$n.days[k3]
        length[k1, sectors.k1[k2], k3] <- tmp$length[k3]
      }
      
    }
  }
  
  return(list(n = n,
              m = m,
              D = D,
              length = length,
              n.sectors = n.sectors))
}

model.file <- "models/model_counts_estimation_v1.txt"
MCMC.params <- list(n.chains = 5,
                    n.samples = 100000,
                    n.burnin = 80000,
                    n.thin = 5)


# Calculate number of days since December 20 of each year
counts.1st.2nd %>% 
  mutate(n.days = 11 + as.numeric(ymd(date) - ymd(paste0(year, "-01-01")))) -> counts.1st.2nd
  
# 
# date_num_df <- data.frame(date_num = unique(counts.1st.2nd$date_num),
#                           date_seq = 1:length(unique(counts.1st.2nd$date_num)))

# numeric sectors
sector_num_df <- data.frame(sector = unique(counts.1st.2nd$sector),
                            sector_num = 1:length(unique(counts.1st.2nd$sector)))

years.df <- data.frame(year = unique(counts.1st.2nd$year)) %>%
    left_join(n.females.df, by = "year") 

counts.1st.2nd %>%
  #left_join(date_num_df, by = "date_num") %>%
  left_join(sector_num_df, by = "sector") %>%
  select(-c(date, date_num)) %>%
  mutate(year_num = year - min(data.1$year) + 1) -> counts.1st.2nd.jags.data

n.years <- length(unique(counts.1st.2nd.jags.data$year_num))
n.sectors <- vector(mode = "numeric", 
                    length = length(unique(counts.1st.2nd.jags.data$year_num)))
sectors <- n.days <- array(dim = c(n.years, length(unique(counts.1st.2nd.jags.data$sector_num))))

k1 <- k2 <- 1
for (k1 in 1:n.years){
  counts.1st.2nd.jags.data %>%
    filter(year_num == k1) -> tmp.k1
  n.sectors[k1] <- length(unique(tmp.k1$sector_num))
  sectors.k1 <- unique(tmp.k1$sector_num)
  for (k2 in 1:n.sectors[k1]){
    tmp.k1 %>% 
      filter(sector_num == sectors.k1[k2]) -> tmp
    n.days[k1, k2] <- nrow(tmp)
    sectors[k1, k2] <- tmp$sector_num[1]
  }
}
 
out.list <- create.n.m.D.length(n.years, n.sectors, n.days, counts.1st.2nd.jags.data)

jags.params <- c("lambda", "p", 
                 "S", "sigma.e",
                 "Y", "mu.Y", "sigma.Y",
                 "B.N.fem",
                 "mu.S", "sigma.S", "deviance")

jags.data <- list(n = out.list$n,
                  m = out.list$m,
                  length = out.list$length,
                  D = out.list$D,
                  sectors = sectors,
                  n.years = length(unique(counts.1st.2nd.jags.data$year_num)),
                  n.sectors = out.list$n.sectors,
                  num.sectors = max(out.list$n.sectors),
                  n.days = n.days,
                  N.fem = as.vector(scale(years.df$n.females)),
                  years = unique(counts.1st.2nd.jags.data$year_num))

jm <- jags(jags.data,
             inits = NULL,
             parameters.to.save= jags.params,
             model.file = model.file,
             n.chains = MCMC.params$n.chains,
             n.burnin = MCMC.params$n.burnin,
             n.thin = MCMC.params$n.thin,
             n.iter = MCMC.params$n.samples,
             DIC = T, parallel=T)
 

```

```{r jags-results-v1-1, echo=FALSE, message=FALSE}

mcmc_trace(jm$samples, c("p[1]", "p[2]", "p[3]", "p[4]", "p[5]"))


```


```{r jags-results-v1-2, echo=FALSE, message=FALSE}

mcmc_trace(jm$samples, c("S[1]", "S[2]", "S[3]", "S[4]", "S[5]"))


```


```{r jags-results-v1-3, echo=FALSE, message=FALSE}

mcmc_trace(jm$samples, c("sigma.e[1]", "sigma.e[2]", "sigma.e[3]", "sigma.e[4]", "sigma.e[5]"))


```


```{r jags-results-v1-4, echo=FALSE, message=FALSE}

mcmc_trace(jm$samples, c("mu.S", "sigma.S"))


```




```{r jags-results-v1-5, echo=FALSE, message=FALSE}

mcmc_trace(jm$samples, c("Y[1]", "Y[2]", "Y[3]", "Y[4]"))


```


```{r jags-results-v1-6, echo=FALSE, message=FALSE}

mcmc_trace(jm$samples, c("mu.Y", "sigma.Y"))


```

The model is appeared to be working. Next is to do cross validation and estimate one m at a time. 

```{r X-validation-1, echo=FALSE, message=FALSE}
model.file <- "models/model_counts_estimation_v1.txt"

if (!file.exists("RData/cross-validation_out_v1.rds")){
  # take one m out at a time and run jags on the modified dataset:
  counts.X.val <- counts.1st.2nd.jags.data %>%
    mutate(estim.X.val = NA,
           q2.5.X.val = NA,
           q97.5.X.val = NA)
  
  k <- 1
  for (k in 1:nrow(counts.1st.2nd.jags.data)){
    x.val.jags.data <- counts.1st.2nd.jags.data
    x.val.jags.data$counts_2[k] <- NA
    Y <- x.val.jags.data$year_num[k]
    S <- x.val.jags.data$sector_num[k]
    
    out.list <- create.n.m.D.length(n.years, n.sectors, n.days, x.val.jags.data)
    
    jags.data <- list(n = out.list$n,
                      m = out.list$m,
                      length = out.list$length,
                      D = out.list$D,
                      sectors = sectors,
                      n.years = length(unique(counts.1st.2nd.jags.data$year_num)),
                      n.sectors = out.list$n.sectors,
                      num.sectors = max(out.list$n.sectors),
                      n.days = n.days,
                      N.fem = years.df$n.females,
                      years = unique(counts.1st.2nd.jags.data$year_num))
    
    jags.params <- c("lambda", "p", "B.N.fem",
                     "B.day", "Y", "S",
                     "mu.S", "sigma.S", 
                     "m", "deviance")
    
    jm <- jags(jags.data,
               inits = NULL,
               parameters.to.save= jags.params,
               model.file = model.file,
               n.chains = MCMC.params$n.chains,
               n.burnin = MCMC.params$n.burnin,
               n.thin = MCMC.params$n.thin,
               n.iter = MCMC.params$n.samples,
               DIC = T, parallel=T)
    
    # find all m in mean, q2.5 and q97.5. Then pull out the one that has different
    # values for those three
    mean.x <- jm$mean$m[Y,S,]
    q2.5.x <- jm$q2.5$m[Y,S,]
    q97.5.x <- jm$q97.5$m[Y,S,]
    
    dif.x <- mean.x - q2.5.x
    
    counts.X.val$estim.X.val[k] <- mean.x[dif.x > 0] %>% na.omit()
    counts.X.val$q2.5.X.val[k] <- q2.5.x[dif.x > 0] %>% na.omit()
    counts.X.val$q97.5.X.val[k] <- q97.5.x[dif.x > 0] %>% na.omit()
    
  }
  
  cross.validation.out <- list(output = counts.X.val,
                               run.date = Sys.Date(),
                               system = Sys.info())
  saveRDS(cross.validation.out,
          file = "RData/cross_validation_out_v1.rds")  
} else {
  
  cross.validation.out <- readRDS(file = "RData/cross_validation_out_v1.rds")
}

ggplot(cross.validation.out$output) +
  #geom_point(aes(x = sector, y = counts_2),
  #           color = "gold") +
  geom_point(aes(x = counts_2, 
                 y = estim.X.val, 
                 color = sector)) +
  geom_errorbar(aes(x = counts_2, 
                    ymin = q2.5.X.val, 
                    ymax = q97.5.X.val,
                    color = sector)) +
  geom_abline(slope = 1, intercept = 0)+
  facet_wrap(~ year)


```

Not very good... Try a different model.

```{r modeling-2, echo=FALSE, message=FALSE}
model.file <- "models/model_counts_estimation_v2.txt"

jags.params <- c("lambda", "p", "B.N.fem",
                 "B.day", "S",
                 "mu.S", "sigma.S", "deviance")

out.list <- create.n.m.D.length(n.years, n.sectors, n.days, counts.1st.2nd.jags.data)

jags.data <- list(n = out.list$n,
                  m = out.list$m,
                  length = out.list$length,
                  D = out.list$D,
                  sectors = sectors,
                  n.years = length(unique(counts.1st.2nd.jags.data$year_num)),
                  n.sectors = out.list$n.sectors,
                  num.sectors = max(out.list$n.sectors),
                  n.days = n.days,
                  N.fem = years.df$n.females,
                  years = unique(counts.1st.2nd.jags.data$year_num))

jm <- jags(jags.data,
             inits = NULL,
             parameters.to.save= jags.params,
             model.file = model.file,
             n.chains = MCMC.params$n.chains,
             n.burnin = MCMC.params$n.burnin,
             n.thin = MCMC.params$n.thin,
             n.iter = MCMC.params$n.samples,
             DIC = T, parallel=T)
 



```


```{r jags-results-v2, echo=FALSE, message=FALSE}

mcmc_trace(jm$samples, c("p[1,1]", "p[2,1]", "p[3,1]", "p[4,1]"))


```


```{r X-validation-2, echo=FALSE, message=FALSE}
model.file <- "models/model_counts_estimation_v2.txt"

if (!file.exists("RData/cross-validation_out_v2.rds")){
  # take one m out at a time and run jags on the modified dataset:
  counts.X.val <- counts.1st.2nd.jags.data %>%
    mutate(estim.X.val = NA,
           q2.5.X.val = NA,
           q97.5.X.val = NA)
  
  k <- 1
  for (k in 1:nrow(counts.1st.2nd.jags.data)){
    x.val.jags.data <- counts.1st.2nd.jags.data
    x.val.jags.data$counts_2[k] <- NA
    Y <- x.val.jags.data$year_num[k]
    S <- x.val.jags.data$sector_num[k]
    
    out.list <- create.n.m.D.length(n.years, n.sectors, n.days, x.val.jags.data)
    
    jags.data <- list(n = out.list$n,
                      m = out.list$m,
                      length = out.list$length,
                      D = out.list$D,
                      sectors = sectors,
                      n.years = length(unique(counts.1st.2nd.jags.data$year_num)),
                      n.sectors = out.list$n.sectors,
                      num.sectors = max(out.list$n.sectors),
                      n.days = n.days,
                      N.fem = years.df$n.females,
                      years = unique(counts.1st.2nd.jags.data$year_num))
    
    jags.params <- c("lambda", "p", "B.N.fem",
                     "B.day", "S",
                     "mu.S", "sigma.S", 
                     "m", "deviance")
    
    jm <- jags(jags.data,
               inits = NULL,
               parameters.to.save= jags.params,
               model.file = model.file,
               n.chains = MCMC.params$n.chains,
               n.burnin = MCMC.params$n.burnin,
               n.thin = MCMC.params$n.thin,
               n.iter = MCMC.params$n.samples,
               DIC = T, parallel=T)
    
    # find all m in mean, q2.5 and q97.5. Then pull out the one that has different
    # values for those three
    mean.x <- jm$mean$m[Y,S,]
    q2.5.x <- jm$q2.5$m[Y,S,]
    q97.5.x <- jm$q97.5$m[Y,S,]
    
    dif.x <- mean.x - q2.5.x
    
    counts.X.val$estim.X.val[k] <- mean.x[dif.x > 0] %>% na.omit()
    counts.X.val$q2.5.X.val[k] <- q2.5.x[dif.x > 0] %>% na.omit()
    counts.X.val$q97.5.X.val[k] <- q97.5.x[dif.x > 0] %>% na.omit()
    
  }
  
  cross.validation.out <- list(output = counts.X.val,
                               run.date = Sys.Date(),
                               system = Sys.info())
  saveRDS(cross.validation.out,
          file = "RData/cross_validation_out_v2.rds")  
} else {
  
  cross.validation.out <- readRDS(file = "RData/cross_validation_out_v2.rds")
}

ggplot(cross.validation.out$output) +
  #geom_point(aes(x = sector, y = counts_2),
  #           color = "gold") +
  geom_point(aes(x = counts_2, 
                 y = estim.X.val, 
                 color = sector)) +
  geom_errorbar(aes(x = counts_2, 
                    ymin = q2.5.X.val, 
                    ymax = q97.5.X.val,
                    color = sector)) +
  geom_abline(slope = 1, intercept = 0)+
  facet_wrap(~ year)


```


## GAM is not going to work {-}
I was going to use GAM but that's not going to work... To predict the second half from first, GAM would require covariates that are available for all hours, not just hours and dates, which are lacking...
The number of observed hatchlings per meter was modeled as a function of time of night (hrs since 1800), year, sector, and survey, which was treated as a random effect. 

I think I have to estimate the proportion of the second half as a function of covariates then estimate the number from the estimated proportion and the observed first half. 2022-11-23

```{r gam, echo=FALSE, message=FALSE}
library(mgcv)
data.1.12hr %>%
  filter(!is.na(counts_m_NA)) -> data.1.12hr.noNA

# Sector as a grouping variable and date_seq (survey ID) as a random effect
gam.1 <- gam(counts_m_NA ~ s(hr) + sector + s(date_seq, bs = "re"),
             data = data.1.12hr.noNA,
             method = "REML")

# Remove sectors 
gam.2 <- gam(counts_m_NA ~ s(hr) +  s(date_seq, bs = "re"),
             data = data.1.12hr.noNA,
             method = "REML")

library(visreg)
visreg(gam.1, 
       xvar = "hr", 
       by = "sector", 
       data = data.1.12hr.noNA, method = "REML")

# visreg(gam.2, xvar = "hr", 
#        data = data.1.12hr.noNA, method = "REML")

data.1 %>% 
    filter(survey_duration_hr == 6) -> data.1.6hr
  
data.1.6hr %>% 
  select(sector, hr, counts_m_NA) %>%
  na.omit() -> data.1.6hr.predict

```


Within year Means with 12-hr surveys

```{r}

counts.1st.2nd %>%
  group_by(year) %>%
  summarise(var = var(ratio),
            mean = mean(ratio)) -> year.var.mean.ratio.12hr


```

Within year means with 6-hr surveys

```{r}
# filter out 6-hr data:
data.1 %>% 
  filter(survey_duration_hr == 6, hr < 7) %>%
  group_by(sector, year, date) %>%
  summarize(across(.cols = counts_m, 
                   .fns = sum, 
                   na.rm = T, .names = "counts_m_1")) -> sum.0.6.hrs.6hr


sum.0.6.hrs.6hr %>%
  group_by(year) %>%
  summarise(var = var(counts_m_1),
            mean = mean(counts_m_1)) -> year.var.mean.6hr

# Combine with 12hr dataset:
sum.6hr <- rbind(sum.0.6.hrs.12hr, sum.0.6.hrs.6hr)

p.counts.first.6hr <- ggplot(data = sum.6hr) +
  geom_point(aes(x = sector, y = counts_m_1)) +
  facet_wrap(~year)

save.fig.fcn(p.counts.first.6hr, 
             file.name = paste0("figures/counts_6hr_all_", dpi.set, "dpi.png"), 
             replace = T, dpi = dpi.set)

```
