---
title: "Hatchling counts modeling"
output: html_notebook
---

I try to model hatchling counts at Raine Island by using a parametric function to determine missing counts.  They are only a few observations each season but the beginning (December 20) and end (April 30) of each season are assumed known. There is a peak during each season.  Different sections (sectors) are treated separately but assumed correlated. The state space of hatchling counts is modeled with an AR(1) process, where the slope (c) is modeled with a discrete Fourier series. 

```{r}
rm(list=ls())

library(tidyverse)
library(ggplot2)
library(lubridate)
library(readr)
library(reshape2)
library(jagsUI)
library(bayesplot)

```

Get the data. Then, create a dataframe containing complete season (DOSeason from 0 to 131) for each season. 

```{r}
col.def <- cols(Date = col_date(format = "%m/%d/%Y"),
                Counts_100m = col_double(),
                Season = col_integer(),
                Sector = col_character())

data.1 <- read_csv(file = "data/Hatchling_Data_v2.csv",
                   col_types = col.def)
data.1.wide <- dcast(data.1, Date ~ Sector, value.var = "Counts_100m")
  #mutate(Year = year(Date)) %>%
  #mutate(DOSeason = as.numeric(Date - as.Date(paste0(Season, "-12-01"))))

summary(data.1)

# create a data frame that repeats nesting season, which will be merged with data.1 to
# create missing data. There are 132 days (from 12/20 to 4/30, if not leap year) within
# each season
n.days <- as.numeric(as.Date("2014-04-30") - as.Date("2013-12-20")) + 1

data.0 <- data.frame(Season = rep(unique(data.1$Season), each = n.days),
                     DOSeason = rep(seq(from = 1, to = n.days, by = 1), 
                                    times = length(unique(data.1$Season))),
                     Counts_100m = NA) %>%
  #mutate(Year = ifelse(DOSeason < 12, Season, Season + 1)) %>%
  mutate(Date = as.Date(paste0(Season, "-12-20")) + days(DOSeason))

data.0 %>% left_join(data.1.wide, by = "Date") -> data.2

obs.y <- t(as.matrix(data.2[, c("2014R", "2017R", "North", "South", "West")]))

```

Then, send these data to jags to fit the model

```{r}
jags.data <- list(y = log(obs.y),
                  mu.X0 = as.vector(c(8,7,6,5,4)),
                  tau.X0 = as.vector(rep(0.1, times = 5)),
                  day = data.2$DOSeason,
                  period = n.days,
                  n.days = n.days,
                  n.sectors = 5,
                  n.steps = ncol(obs.y),
                  pi = pi)

MCMC.params <- list(n.chains = 5,
                    n.samples = 1000000,
                    n.burnin = 700000,
                    n.thin = 5)

if (!file.exists("RData/Fourier_imputation_dnorm.rds")){
  jags.params <- c("c", "beta.cos", "beta.sin",
                   "sigma.X", "sigma.y", "y",
                   "X", "deviance")
  
  jm <- jags(jags.data,
             inits = NULL,
             parameters.to.save= jags.params,
             model.file = 'models/model_Fourier_imputation_dnorm.txt',
             n.chains = MCMC.params$n.chains,
             n.burnin = MCMC.params$n.burnin,
             n.thin = MCMC.params$n.thin,
             n.iter = MCMC.params$n.samples,
             DIC = T, parallel=T)
  
  saveRDS(jm, "RData/Fourier_imputation_dnorm.rds")
  
} else {
  jm <- readRDS("RData/Fourier_imputation_dnorm.rds")
}


```


```{r}
if (!file.exists("RData/Fourier_imputation_dt.rds")){
  jags.params <- c("c", "beta.cos", "beta.sin",
                   "sigma.X", "sigma.y", "y",
                   "X", "df.X", "deviance")
  
  jm <- jags(jags.data,
             inits = NULL,
             parameters.to.save= jags.params,
             model.file = 'models/model_Fourier_imputation_dt.txt',
             n.chains = MCMC.params$n.chains,
             n.burnin = MCMC.params$n.burnin,
             n.thin = MCMC.params$n.thin,
             n.iter = MCMC.params$n.samples,
             DIC = T, parallel=T)
  
  saveRDS(jm, "RData/Fourier_imputation_dt.rds")
  
} else {
  jm <- readRDS("RData/Fourier_imputation_dt.rds")
}

```



```{r}
if (!file.exists("RData/Fourier_imputation_dt_dt.rds")){
  jags.params <- c("c", "beta.cos", "beta.sin",
                   "sigma.X", "sigma.y", "y",
                   "X", "df.X", "df.y", "deviance")
  
  jm <- jags(jags.data,
             inits = NULL,
             parameters.to.save= jags.params,
             model.file = 'models/model_Fourier_imputation_dt_dt.txt',
             n.chains = MCMC.params$n.chains,
             n.burnin = MCMC.params$n.burnin,
             n.thin = MCMC.params$n.thin,
             n.iter = MCMC.params$n.samples,
             DIC = T, parallel=T)
  
  saveRDS(jm, "RData/Fourier_imputation_dt_dt.rds")
  
} else {
  jm <- readRDS("RData/Fourier_imputation_dt_dt.rds")
}

```


```{r}
mcmc_trace(jm$samples, "c[1]")
```

