---
title: "Hatchling counts modeling"
output: html_notebook
---

I try to model hatchling counts at Raine Island by using a parametric function to determine missing counts.  They are only a few observations each season but the beginning (December 20) and end (April 30) of each season are assumed known. There is a peak during each season.  Different sections (sectors) are treated separately but assumed correlated. The state space of hatchling counts is modeled with an AR(1) process, where the slope (c) is modeled with a discrete Fourier series. 

```{r}
rm(list=ls())

library(tidyverse)
library(ggplot2)
library(lubridate)
library(readr)
library(reshape2)
library(jagsUI)
library(bayesplot)

```

Get the data. Then, create a dataframe containing complete season (DOSeason from 0 to 131) for each season. 

```{r}
col.def <- cols(Date = col_date(format = "%m/%d/%Y"),
                Counts_100m = col_double(),
                Season = col_integer(),
                Sector = col_character())

data.1 <- read_csv(file = "data/Hatchling_Data_v2.csv",
                   col_types = col.def)
data.1.wide <- dcast(data.1, Date ~ Sector, value.var = "Counts_100m")
  #mutate(Year = year(Date)) %>%
  #mutate(DOSeason = as.numeric(Date - as.Date(paste0(Season, "-12-01"))))

summary(data.1)

# create a data frame that repeats nesting season, which will be merged with data.1 to
# create missing data. There are 132 days (from 12/20 to 4/30, if not leap year) within
# each season
data.0 <- data.frame(Season = rep(unique(data.1$Season), each = 132),
                     DOSeason = rep(seq(from = 1, to = 132, by = 1), 
                                    times = length(unique(data.1$Season))),
                     Counts_100m = NA) %>%
  #mutate(Year = ifelse(DOSeason < 12, Season, Season + 1)) %>%
  mutate(Date = as.Date(paste0(Season, "-12-20")) + days(DOSeason))

data.0 %>% left_join(data.1.wide, by = "Date") -> data.2

data.2 %>% select(Season, DOSeason, `2014R`, `2017R`, North, South, West) -> data.2.a

obs.y <- array(NA, c(4, 5, 132))

obs.y[1, ,] <- t(filter(data.2.a, Season == 2014) %>% select(-c("Season", "DOSeason")))
obs.y[2, ,] <- t(filter(data.2.a, Season == 2015) %>% select(-c("Season", "DOSeason")))
obs.y[3, ,] <- t(filter(data.2.a, Season == 2016) %>% select(-c("Season", "DOSeason")))
obs.y[4, ,] <- t(filter(data.2.a, Season == 2017) %>% select(-c("Season", "DOSeason")))

#obs.y <- t(as.matrix(data.2[, c("2014R", "2017R", "North", "South", "West")]))

```

Take a look at the data:

```{r}
ggplot(data = data.1) + 
  geom_point(aes(x = Date, y = Counts_100m)) +
  facet_grid(Sector ~.)


```

Data are limited but there are correlations among locations.  This makes sense because nesting occurs all at once.  So, one function can be used to describe the nesting pattern but the magnitude is different among locations.  The estimaed correlations can be helpful in imputing missing data points. 

```{r}
pairs(data.2[, c(5:9)])
  

```

I have a tentative model that uses discrete a Fourier series with normal observation models to impute missing data.  Send these data to jags to fit the model

```{r}
# initial value is -2 for unobserved X0, which is pretty close to zero in anti-log space.  
jags.data <- list(y = log(obs.y),
                  mu.X0 = array(data = -2, dim = c(dim(obs.y)[1], dim(obs.y)[2])),
                  day = data.2$DOSeason,
                  period = dim(obs.y)[3],
                  n.steps = dim(obs.y)[3],
                  n.sectors = dim(obs.y)[2],
                  n.years = dim(obs.y)[1],
                  pi = pi)

jags.params <- c("c", "beta.cos", "beta.sin",
                 #"sigma.X", 
                 "sigma.y", 
                 "y", "X", "deviance")

MCMC.params <- list(n.chains = 3,
                    n.samples = 100000,
                    n.burnin = 80000,
                    n.thin = 5)


if (!file.exists("RData/Fourier_imputation_dnorm.rds")){
  jm <- jags(jags.data,
             inits = NULL,
             parameters.to.save= jags.params,
             model.file = 'models/model_Fourier_imputation_dnorm.txt',
             n.chains = MCMC.params$n.chains,
             n.burnin = MCMC.params$n.burnin,
             n.thin = MCMC.params$n.thin,
             n.iter = MCMC.params$n.samples,
             DIC = T, parallel=T)
  
  # jm <- autojags(jags.data,
  #                inits = NULL,
  #                parameters.to.save= jags.params,
  #                model.file = 'models/model_Fourier_imputation_dnorm.txt',
  #                n.chains = MCMC.params$n.chains,
  #                n.burnin = MCMC.params$n.burnin,
  #                n.thin = MCMC.params$n.thin,
  #                
  #                max.iter = 500000,
  #                DIC = T, parallel=T)
  saveRDS(jm, "RData/Fourier_imputation_dnorm.rds")
  
} else {
  jm <- readRDS("RData/Fourier_imputation_dnorm.rds")
}


```

put together estimated Xs and observed ys.

```{r}
define.df <- function(x) { 
  y <- data.frame(t(x))
  colnames(y) <- c("2014R_q50", "2017R_q50", 
                   "North_q50", "South_q50", "West_q50")
  y$DOSeason <- seq(1, nrow(y))
  return(y)}

ys_q50 <- apply(jm$q50$y, MARGIN = 1, FUN = define.df)
ys_q2.5 <- apply(jm$q2.5$y, MARGIN = 1, FUN = define.df)
ys_q97.5 <- apply(jm$q97.5$y, MARGIN = 1, FUN = define.df)

# ys_q2.5.long <- melt(ys_q2.5, value.name = "y_q2.5")
# ys_q50.long <- melt(ys_q50, value.name = "y_q50")
# ys_q97.5.long <- melt(ys_q97.5, value.name = "y_q97.5")

Xs_q50 <- apply(jm$q50$X, MARGIN = 1, 
                FUN = define.df)

Xs_q2.5 <- apply(jm$q2.5$X, MARGIN = 1, FUN = define.df)
               
Xs_q97.5 <- apply(jm$q97.5$X, MARGIN = 1, FUN = define.df)

# Xs_q2.5.long <- melt(Xs_q2.5, value.name = "X_q2.5")
# 
# Xs_q50.long <- melt(Xs_q50, value.name = "X_q50")
# 
# Xs_q97.5.long <- melt(Xs_q97.5, value.name = "y_q97.5")
seasons <- c(2014, 2015, 2016, 2017)
for (s in 1:4){
  Xs_q50[[s]]$Season <- seasons[s]
  Xs_q2.5[[2]]$Season  <- seasons[s]
  Xs_q97.5[[2]]$Season  <- seasons[s]
  
  ys_q50[[s]]$Season <- seasons[s]
  ys_q2.5[[2]]$Season  <- seasons[s]
  ys_q97.5[[2]]$Season  <- seasons[s]
}


#data.3.long <- rbind(data.2, ys.q2.5, ys.q50, ys.q97.5, Xs.q2.5, Xs.q50, Xs.q97.5)
#rm(list = c("jm"))
```

See how they look:

```{r}
ggplot() + 
  #geom_path(aes(x = Date, y = `2014R_y_q50`),
  #          size = 1.5) + 
  geom_path(data = do.call(rbind, Xs_q50) ,
            aes(x = DOSeason, y = `2014R_q50`,
                color = as.factor(Season))) + 
  geom_point(data = data.2,
             aes(x = DOSeason, y = log(`2014R`),
                 color = as.factor(Season)),
             size = 2, shape = 4)
```

Needs to be looked at... 

This doesn't look so bad!  This was from an earlier version... which I didn't keep...

```{r}
ggplot(data = data.3.wide) + 
  #geom_path(aes(x = Date, y = `2017R_y_q50`),
  #          size = 1.5) + 
  geom_path(aes(x = Date, y = `2017R_X_q50`),
            color = "forestgreen") + 
  geom_point(aes(x = Date, y = log(`2017R`)),
             size = 2, shape = 4)
```


```{r}
ggplot(data = data.3.wide) + 
  #geom_path(aes(x = Date, y = North),
  #          size = 1.5) + 
  geom_path(aes(x = Date, y = North_X_q50),
            color = "forestgreen") + 
  geom_point(aes(x = Date, y = log(North)),
             size = 2, shape = 4)
```




```{r}
ggplot(data = data.3.wide) + 
  #geom_path(aes(x = Date, y = South),
  #          size = 1.5) + 
  geom_path(aes(x = Date, y = South_X_q50),
            color = "forestgreen") + 
  geom_point(aes(x = Date, y = log(South)),
             size = 2, shape = 4)
```







```{r}
ggplot(data = data.3.wide) + 
  #geom_path(aes(x = Date, y = West),
  #          size = 1.5) + 
  geom_path(aes(x = Date, y = West_X_q50),
            color = "forestgreen") + 
  geom_point(aes(x = Date, y = log(West)),
             size = 2, shape = 4)
```

How do they look with DOSeason:

```{r}
ggplot(data = data.3.wide) + 
  geom_point(aes(x = DOSeason, y = `2014R_X_q50`,
                 color = as.factor(Season))) + 
  geom_point(aes(x = DOSeason, y = log(`2014R`), 
                 color = as.factor(Season)),
             shape = 4, size = 1.5)
```


```{r}
ggplot(data = data.3.wide) + 
  geom_point(aes(x = DOSeason, y = `2017R_X_q50`,
                 color = as.factor(Season))) + 
  geom_point(aes(x = DOSeason, y = log(`2017R`), 
                 color = as.factor(Season)),
             shape = 4, size = 1.5)
```


```{r}
ggplot(data = data.3.wide) + 
  geom_point(aes(x = DOSeason, y = North_X_q50,
                 color = as.factor(Season))) + 
  geom_point(aes(x = DOSeason, y = log(North), 
                 color = as.factor(Season)),
             shape = 4, size = 1.5)
```


```{r}
ggplot(data = data.3.wide) + 
  geom_point(aes(x = DOSeason, y = South_X_q50,
                 color = as.factor(Season))) + 
  geom_point(aes(x = DOSeason, y = log(South), 
                 color = as.factor(Season)),
             shape = 4, size = 1.5)
```


```{r}
ggplot(data = data.3.wide) + 
  geom_point(aes(x = DOSeason, y = West_X_q50,
                 color = as.factor(Season))) + 
  geom_point(aes(x = DOSeason, y = log(West), 
                 color = as.factor(Season)),
             shape = 4, size = 1.5)
```

Adding 95% CIs:


```{r}
ggplot(data = data.3.wide) + 
  geom_point(aes(x = DOSeason, y = `2014R_X_q50`,
                 color = as.factor(Season))) + 
  geom_point(aes(x = DOSeason, y = log(`2014R`), 
                 color = as.factor(Season)),
             shape = 4, size = 1.5) + 
  geom_errorbar(aes(x = DOSeason, 
                    ymin = `2014R_X_q2.5`, 
                    ymax = `2014R_X_q97.5`,
                    color = as.factor(Season)))
```


```{r}
ggplot(data = data.3.wide) + 
  geom_point(aes(x = DOSeason, y = `2017R_X_q50`,
                 color = as.factor(Season))) + 
  geom_point(aes(x = DOSeason, y = log(`2017R`), 
                 color = as.factor(Season)),
             shape = 4, size = 1.5)+ 
  geom_errorbar(aes(x = DOSeason, 
                    ymin = `2017R_X_q2.5`, 
                    ymax = `2017R_X_q97.5`,
                    color = as.factor(Season)))
```


```{r}
ggplot(data = data.3.wide) + 
  geom_point(aes(x = DOSeason, y = North_X_q50,
                 color = as.factor(Season))) + 
  geom_point(aes(x = DOSeason, y = log(North), 
                 color = as.factor(Season)),
             shape = 4, size = 1.5) + 
  geom_errorbar(aes(x = DOSeason, 
                    ymin = North_X_q2.5, 
                    ymax = North_X_q97.5,
                    color = as.factor(Season)))
```


```{r}
ggplot(data = data.3.wide) + 
  geom_point(aes(x = DOSeason, y = South_X_q50,
                 color = as.factor(Season))) + 
  geom_point(aes(x = DOSeason, y = log(South), 
                 color = as.factor(Season)),
             shape = 4, size = 1.5) + 
  geom_errorbar(aes(x = DOSeason, 
                    ymin = South_X_q2.5, 
                    ymax = South_X_q97.5,
                    color = as.factor(Season)))
```


```{r}
ggplot(data = data.3.wide) + 
  geom_point(aes(x = DOSeason, y = West_X_q50,
                 color = as.factor(Season))) + 
  geom_point(aes(x = DOSeason, y = log(West), 
                 color = as.factor(Season)),
             shape = 4, size = 1.5) + 
  geom_errorbar(aes(x = DOSeason, 
                    ymin = West_X_q2.5, 
                    ymax = West_X_q97.5,
                    color = as.factor(Season)))
```

