---
title: "Hatchling counts modeling"
output: html_notebook
---

I try to model hatchling counts at Raine Island by using a parametric function to determine missing counts.  They are only a few observations each season but the beginning (December 20) and end (April 30) of each season are assumed known. There is a peak during each season.  Different sections (sectors) are treated separately but assumed correlated. The state space of hatchling counts is modeled with an AR(1) process, where the slope (c) is modeled with a discrete Fourier series. 

```{r}
rm(list=ls())

library(tidyverse)
library(ggplot2)
library(lubridate)
library(readr)
library(reshape2)
library(jagsUI)
library(bayesplot)

```

Get the data. Then, create a dataframe containing complete season (DOSeason from 0 to 131) for each season. 

```{r}
col.def <- cols(Date = col_date(format = "%m/%d/%Y"),
                Counts_100m = col_double(),
                Season = col_integer(),
                Sector = col_character())

data.1 <- read_csv(file = "data/Hatchling_Data_v2.csv",
                   col_types = col.def)
data.1.wide <- dcast(data.1, Date ~ Sector, value.var = "Counts_100m")
  #mutate(Year = year(Date)) %>%
  #mutate(DOSeason = as.numeric(Date - as.Date(paste0(Season, "-12-01"))))

summary(data.1)

# create a data frame that repeats nesting season, which will be merged with data.1 to
# create missing data. There are 132 days (from 12/20 to 4/30, if not leap year) within
# each season
data.0 <- data.frame(Season = rep(unique(data.1$Season), each = 132),
                     DOSeason = rep(seq(from = 1, to = 132, by = 1), 
                                    times = length(unique(data.1$Season))),
                     Counts_100m = NA) %>%
  #mutate(Year = ifelse(DOSeason < 12, Season, Season + 1)) %>%
  mutate(Date = as.Date(paste0(Season, "-12-20")) + days(DOSeason))

data.0 %>% left_join(data.1.wide, by = "Date") -> data.2

data.2 %>% select(Season, DOSeason, `2014R`, `2017R`, North, South, West) -> data.2.a

obs.y <- array(NA, c(4, 5, 132))

obs.y[1, ,] <- t(filter(data.2.a, Season == 2014) %>% select(-c("Season", "DOSeason")))
obs.y[2, ,] <- t(filter(data.2.a, Season == 2015) %>% select(-c("Season", "DOSeason")))
obs.y[3, ,] <- t(filter(data.2.a, Season == 2016) %>% select(-c("Season", "DOSeason")))
obs.y[4, ,] <- t(filter(data.2.a, Season == 2017) %>% select(-c("Season", "DOSeason")))

#obs.y <- t(as.matrix(data.2[, c("2014R", "2017R", "North", "South", "West")]))

```

Take a look at the data:

```{r}
ggplot(data = data.1) + 
  geom_point(aes(x = Date, y = Counts_100m)) +
  facet_grid(Sector ~.)


```

Data are limited but there are correlations among locations.  This makes sense because nesting occurs all at once.  So, one function can be used to describe the nesting pattern but the magnitude is different among locations.  The estimaed correlations can be helpful in imputing missing data points. 

```{r}
pairs(data.2[, c(5:9)])
  

```

I have a tentative model that uses discrete a Fourier series with normal observation models to impute missing data.  Send these data to jags to fit the model

```{r}
# initial value is -2 for unobserved X0, which is pretty close to zero in anti-log space.  
jags.data <- list(y = log(obs.y),
                  mu.X0 = array(data = -2, dim = c(dim(obs.y)[1], dim(obs.y)[2])),
                  day = data.2$DOSeason,
                  period = dim(obs.y)[3],
                  n.steps = dim(obs.y)[3],
                  n.sectors = dim(obs.y)[2],
                  n.years = dim(obs.y)[1],
                  pi = pi)

jags.params <- c("beta.cos", "beta.sin",
                 #"sigma.X", 
                 "sigma.y", 
                 "y", "X", "deviance")

MCMC.params <- list(n.chains = 3,
                    n.samples = 100000,
                    n.burnin = 80000,
                    n.thin = 5)


if (!file.exists("RData/Fourier_imputation_dnorm.rds")){
  jm <- jags(jags.data,
             inits = NULL,
             parameters.to.save= jags.params,
             model.file = 'models/model_Fourier_imputation_dnorm.txt',
             n.chains = MCMC.params$n.chains,
             n.burnin = MCMC.params$n.burnin,
             n.thin = MCMC.params$n.thin,
             n.iter = MCMC.params$n.samples,
             DIC = T, parallel=T)
  
  # jm <- autojags(jags.data,
  #                inits = NULL,
  #                parameters.to.save= jags.params,
  #                model.file = 'models/model_Fourier_imputation_dnorm.txt',
  #                n.chains = MCMC.params$n.chains,
  #                n.burnin = MCMC.params$n.burnin,
  #                n.thin = MCMC.params$n.thin,
  #                
  #                max.iter = 500000,
  #                DIC = T, parallel=T)
  saveRDS(jm, "RData/Fourier_imputation_dnorm.rds")
  
} else {
  jm <- readRDS("RData/Fourier_imputation_dnorm.rds")
}


```

put together estimated Xs and observed ys.

```{r}
define.df_q50 <- function(x) { 
  y <- data.frame(t(x))
  colnames(y) <- c("2014R_q50", "2017R_q50", 
                   "North_q50", "South_q50", "West_q50")
  y$DOSeason <- seq(1, nrow(y))
  return(y)}

define.df_q2.5 <- function(x) { 
  y <- data.frame(t(x))
  colnames(y) <- c("2014R_q2.5", "2017R_q2.5", 
                   "North_q2.5", "South_q2.5", "West_q2.5")
  y$DOSeason <- seq(1, nrow(y))
  return(y)}

define.df_q97.5 <- function(x) { 
  y <- data.frame(t(x))
  colnames(y) <- c("2014R_q97.5", "2017R_q97.5", 
                   "North_q97.5", "South_q97.5", "West_q97.5")
  y$DOSeason <- seq(1, nrow(y))
  return(y)}

ys_q50 <- apply(jm$q50$y, MARGIN = 1, FUN = define.df_q50)
ys_q2.5 <- apply(jm$q2.5$y, MARGIN = 1, FUN = define.df_q2.5)
ys_q97.5 <- apply(jm$q97.5$y, MARGIN = 1, FUN = define.df_q97.5)

# ys_q2.5.long <- melt(ys_q2.5, value.name = "y_q2.5")
# ys_q50.long <- melt(ys_q50, value.name = "y_q50")
# ys_q97.5.long <- melt(ys_q97.5, value.name = "y_q97.5")

Xs_q50 <- apply(jm$q50$X, MARGIN = 1, 
                FUN = define.df_q50)

Xs_q2.5 <- apply(jm$q2.5$X, MARGIN = 1, FUN = define.df_q2.5)
               
Xs_q97.5 <- apply(jm$q97.5$X, MARGIN = 1, FUN = define.df_q97.5)

# Xs_q2.5.long <- melt(Xs_q2.5, value.name = "X_q2.5")
# 
# Xs_q50.long <- melt(Xs_q50, value.name = "X_q50")
# 
# Xs_q97.5.long <- melt(Xs_q97.5, value.name = "y_q97.5")

seasons <- c(2014, 2015, 2016, 2017)
for (s in 1:4){
  Xs_q50[[s]]$Season <- seasons[s]
  Xs_q2.5[[s]]$Season  <- seasons[s]
  Xs_q97.5[[s]]$Season  <- seasons[s]
  
  ys_q50[[s]]$Season <- seasons[s]
  ys_q2.5[[s]]$Season  <- seasons[s]
  ys_q97.5[[s]]$Season  <- seasons[s]
}

Xs_q2.5_df <- do.call(rbind, Xs_q2.5)
Xs_q50_df <- do.call(rbind, Xs_q50)
Xs_q97.5_df <- do.call(rbind, Xs_q97.5)

Xs_2014R <- cbind(Xs_q2.5_df$`2014R_q2.5`, Xs_q50_df$`2014R_q50`,
                  Xs_q97.5_df$`2014R_q97.5`, Xs_q2.5_df[, c("DOSeason", "Season")])
colnames(Xs_2014R) <- c("Xs_q2.5", "Xs_q50", "Xs_q97.5", "DOSeason", "Season")

Xs_2017R <- cbind(Xs_q2.5_df$`2017R_q2.5`, Xs_q50_df$`2017R_q50`,
                  Xs_q97.5_df$`2017R_q97.5`, Xs_q2.5_df[, c("DOSeason", "Season")])
colnames(Xs_2017R) <- c("Xs_q2.5", "Xs_q50", "Xs_q97.5", "DOSeason", "Season")

Xs_North <- cbind(Xs_q2.5_df$North_q2.5, Xs_q50_df$North_q50,
                  Xs_q97.5_df$North_q97.5, Xs_q2.5_df[, c("DOSeason", "Season")])
colnames(Xs_North) <- c("Xs_q2.5", "Xs_q50", "Xs_q97.5", "DOSeason", "Season")

Xs_South <- cbind(Xs_q2.5_df$South_q2.5, Xs_q50_df$South_q50,
                  Xs_q97.5_df$South_q97.5, Xs_q2.5_df[, c("DOSeason", "Season")])
colnames(Xs_South) <- c("Xs_q2.5", "Xs_q50", "Xs_q97.5", "DOSeason", "Season")

Xs_West <- cbind(Xs_q2.5_df$West_q2.5, Xs_q50_df$West_q50,
                  Xs_q97.5_df$West_q97.5, Xs_q2.5_df[, c("DOSeason", "Season")])
colnames(Xs_West) <- c("Xs_q2.5", "Xs_q50", "Xs_q97.5", "DOSeason", "Season")

#data.3.long <- rbind(data.2, ys.q2.5, ys.q50, ys.q97.5, Xs.q2.5, Xs.q50, Xs.q97.5)
#rm(list = c("jm"))
```

See how they look:

```{r}
ggplot() + 
  geom_path(data = Xs_q50_df ,
            aes(x = DOSeason, y = `2014R_q50`,
                color = as.factor(Season)),
            size = 1.2) + 
  geom_point(data = data.2,
             aes(x = DOSeason, y = log(`2014R`),
                 color = as.factor(Season)),
             size = 2, shape = 16) +
  labs(title = "2014R", x = "Days since December 21", y = "Median counts",
       color = "Season") +
  theme(axis.text = element_text(size = 12),
        legend.position = c(0.1, 0.8),
        axis.title = element_text(size = 12))
```

This looks good!  Having separate beta.cos and beta.sin coefficients for different years seems to work good.

```{r}
ggplot() + 
  geom_path(data = Xs_q50_df ,
            aes(x = DOSeason, y = `2017R_q50`,
                color = as.factor(Season)),
            size = 1.2) + 
  geom_point(data = data.2,
             aes(x = DOSeason, y = log(`2017R`),
                 color = as.factor(Season)),
             size = 2, shape = 16) +
  labs(title = "2017R", x = "Days since December 21", y = "Median counts",
       color = "Season") +
  theme(axis.text = element_text(size = 12),
        legend.position = c(0.1, 0.8),
        axis.title = element_text(size = 12))
```


```{r}

ggplot() + 
  geom_path(data = Xs_q50_df ,
            aes(x = DOSeason, y = North_q50,
                color = as.factor(Season)),
            size = 1.2) + 
  geom_point(data = data.2,
             aes(x = DOSeason, y = log(North),
                 color = as.factor(Season)),
             size = 2, shape = 16) +
  labs(title = "North", x = "Days since December 21", y = "Median counts",
       color = "Season") +
  theme(axis.text = element_text(size = 12),
        legend.position = c(0.1, 0.8),
        axis.title = element_text(size = 12))

```


```{r}
ggplot() + 
  geom_path(data = Xs_q50_df ,
            aes(x = DOSeason, y = South_q50,
                color = as.factor(Season)),
            size = 1.2) + 
  geom_point(data = data.2,
             aes(x = DOSeason, y = log(South),
                 color = as.factor(Season)),
             size = 2, shape = 16)+
  labs(title = "South", x = "Days since December 21", y = "Median counts",
       color = "Season") +
  theme(axis.text = element_text(size = 12),
        legend.position = c(0.1, 0.8),
        axis.title = element_text(size = 12))

```



```{r}
ggplot() + 
  geom_path(data = Xs_q50_df ,
            aes(x = DOSeason, y = West_q50,
                color = as.factor(Season)),
            size = 1.2) + 
  geom_point(data = data.2,
             aes(x = DOSeason, y = log(West),
                 color = as.factor(Season)),
             size = 2, shape = 16) +
  labs(title = "West", x = "Days since December 21", y = "Median counts",
       color = "Season") +
  theme(axis.text = element_text(size = 12),
        legend.position = c(0.1, 0.8),
        axis.title = element_text(size = 12))

```



Adding 95% CIs:


```{r}


ggplot() + 
  geom_path(data = Xs_2017R ,
            aes(x = DOSeason, y = Xs_q50,
                color = as.factor(Season))) +
  geom_errorbar(data = Xs_2017R, 
                aes(x = DOSeason,
                    ymin = Xs_q2.5, 
                    ymax = Xs_q97.5,
                    color = as.factor(Season))) +  
  geom_point(data = data.2,
             aes(x = DOSeason, y = log(`2017R`),
                 color = as.factor(Season)),
             size = 2, shape = 16) +
  labs(title = "2017R", 
       x = "Days since December 21", y = "Median counts and 95% CI",
       color = "Season") +
  theme(axis.text = element_text(size = 12),
        legend.position = c(0.1, 0.8),
        axis.title = element_text(size = 12))
```

Probably shouldn't have these other years... 


```{r}

ggplot() + 
  geom_path(data = Xs_2014R ,
            aes(x = DOSeason, y = Xs_q50,
                color = as.factor(Season))) +
  geom_errorbar(data = Xs_2014R, 
                aes(x = DOSeason,
                    ymin = Xs_q2.5, 
                    ymax = Xs_q97.5,
                    color = as.factor(Season))) +  
  geom_point(data = data.2,
             aes(x = DOSeason, y = log(`2014R`),
                 color = as.factor(Season)),
             size = 2, shape = 16) +
  labs(title = "2014R", x = "Days since December 21", y = "Median counts and 95% CI",
       color = "Season") +
  theme(axis.text = element_text(size = 12),
        legend.position = c(0.1, 0.8),
        axis.title = element_text(size = 12))

```




```{r}

ggplot() + 
  geom_path(data = Xs_North ,
            aes(x = DOSeason, y = Xs_q50,
                color = as.factor(Season))) +
  geom_errorbar(data = Xs_North, 
                aes(x = DOSeason,
                    ymin = Xs_q2.5, 
                    ymax = Xs_q97.5,
                    color = as.factor(Season))) +  
  geom_point(data = data.2,
             aes(x = DOSeason, y = log(North),
                 color = as.factor(Season)),
             size = 2, shape = 16)+
  labs(title = "North", x = "Days since December 21", y = "Median counts and 95% CI",
       color = "Season") +
  theme(axis.text = element_text(size = 12),
        legend.position = c(0.1, 0.8),
        axis.title = element_text(size = 12))

```



```{r}
ggplot() + 
  geom_path(data = Xs_South ,
            aes(x = DOSeason, y = Xs_q50,
                color = as.factor(Season))) +
  geom_errorbar(data = Xs_South, 
                aes(x = DOSeason,
                    ymin = Xs_q2.5, 
                    ymax = Xs_q97.5,
                    color = as.factor(Season))) +  
  geom_point(data = data.2,
             aes(x = DOSeason, y = log(South),
                 color = as.factor(Season)),
             size = 2, shape = 16) +
  labs(title = "South", x = "Days since December 21", y = "Median counts and 95% CI",
       color = "Season") +
  theme(axis.text = element_text(size = 12),
        legend.position = c(0.1, 0.8),
        axis.title = element_text(size = 12))


```

```{r}
ggplot() + 
  geom_path(data = Xs_West ,
            aes(x = DOSeason, y = Xs_q50,
                color = as.factor(Season))) +
  geom_errorbar(data = Xs_West, 
                aes(x = DOSeason,
                    ymin = Xs_q2.5, 
                    ymax = Xs_q97.5,
                    color = as.factor(Season))) +  
  geom_point(data = data.2,
             aes(x = DOSeason, y = log(West),
                 color = as.factor(Season)),
             size = 2, shape = 16)+
  labs(title = "West", x = "Days since December 21", y = "Median counts and 95% CI",
       color = "Season") +
  theme(axis.text = element_text(size = 12),
        legend.position = c(0.1, 0.8),
        axis.title = element_text(size = 12))

```

Now that we seem to have pretty "believable" models for all these data, we can go ahead and sum the imputed counts with confidence bands.  

For 2014, we add 2014R, South, North, and West areas.  2017R did not exist until 2017.
```{r}
Xs_2014R %>% group_by(as.factor(Season)) %>%
  summarise(q50 = sum(exp(Xs_q50)),
            q2.5 = sum(exp(Xs_q2.5)),
            q97.5 = sum(exp(Xs_q97.5))) %>%
  mutate(Sector = "R2014") -> Xs_2014R_summary

colnames(Xs_2014R_summary) <- c("Season", "q50", "q2.5", "q97.5", "Sector")

Xs_North %>% group_by(as.factor(Season)) %>%
  summarise(q50 = sum(exp(Xs_q50)),
            q2.5 = sum(exp(Xs_q2.5)),
            q97.5 = sum(exp(Xs_q97.5))) %>%
  mutate(Sector = "North") -> Xs_North_summary
colnames(Xs_North_summary) <- c("Season", "q50", "q2.5", "q97.5", "Sector")

Xs_South %>% group_by(as.factor(Season)) %>%
  summarise(q50 = sum(exp(Xs_q50)),
            q2.5 = sum(exp(Xs_q2.5)),
            q97.5 = sum(exp(Xs_q97.5))) %>%
  mutate(Sector = "South") -> Xs_South_summary
colnames(Xs_South_summary) <- c("Season", "q50", "q2.5", "q97.5", "Sector")

Xs_West %>% group_by(as.factor(Season)) %>%
  summarise(q50 = sum(exp(Xs_q50)),
            q2.5 = sum(exp(Xs_q2.5)),
            q97.5 = sum(exp(Xs_q97.5))) %>%
  mutate(Sector = "West") -> Xs_West_summary
colnames(Xs_West_summary) <- c("Season", "q50", "q2.5", "q97.5", "Sector")

Xs_2017R %>% filter(Season == 2017) %>%
  summarise(q50 = sum(exp(Xs_q50)),
            q2.5 = sum(exp(Xs_q2.5)),
            q97.5 = sum(exp(Xs_q97.5))) %>%
  mutate(Sector = "R2017",
         Season = "2017") -> Xs_2017R_summary
colnames(Xs_2017R_summary) <- c("Season", "q50", "q2.5", "q97.5", "Sector")

all.summary <- rbind(Xs_2014R_summary,
                     Xs_North_summary,
                     Xs_South_summary,
                     Xs_West_summary)

ggplot(data = all.summary) + 
  geom_point(aes(x = Season, y = log10(q50))) + 
  geom_errorbar(aes(x = Season, ymin = log10(q2.5), ymax = log10(q97.5))) +
  facet_grid(Sector ~. )
```

